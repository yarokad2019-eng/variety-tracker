<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>××¢×§×‘ ×–× ×™× ××™×•×—×“×™×</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3B2A1A">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="××¢×§×‘ ×–× ×™×">
<meta name="mobile-web-app-capable" content="yes">

<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --bark:      #3B2A1A;
  --bark-mid:  #5C4033;
  --soil:      #7A5C3A;
  --clay:      #A0784A;
  --sand:      #C8A97A;
  --linen:     #F2EAD8;
  --cream:     #FAF6EE;
  --parchment: #EFE6D0;
  --leaf:      #4A6B2A;
  --leaf-mid:  #6A9040;
  --leaf-light:#9DC062;
  --moss:      #8B9E55;
  --rust:      #B85C2A;
  --amber:     #D4890A;
  --sky:       #3A6B8A;
  --text:      #1E1410;
  --text-mid:  #4A3828;
  --text-soft: #7A6250;
  --border:    #D4C4A8;
  --shadow:    0 3px 12px rgba(59,42,26,.12);
  --shadow-lg: 0 8px 28px rgba(59,42,26,.20);
  --r:         14px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{font-family:'Heebo',sans-serif;background:var(--cream);color:var(--text);min-height:100vh;padding-bottom:80px;}

/* â”€â”€ HEADER â”€â”€ */
.hdr{
  background: linear-gradient(160deg, var(--bark) 0%, var(--bark-mid) 60%, var(--soil) 100%);
  padding:18px 20px 16px; color:white;
  position:sticky;top:0;z-index:100;
  box-shadow:0 4px 20px rgba(0,0,0,.28);
}
.hdr-top{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;}
.hdr h1{font-size:clamp(16px,4.5vw,22px);font-weight:900;line-height:1.2;letter-spacing:-.2px;}
.hdr h1 .leaf{font-size:1.1em;margin-left:6px;}
.hdr-sub{font-size:11px;opacity:.7;margin-top:3px;font-weight:400;}
.hdr-btns{display:flex;gap:7px;flex-shrink:0;}
.hbtn{border:none;border-radius:8px;padding:8px 13px;font-size:12px;font-weight:700;font-family:'Heebo',sans-serif;cursor:pointer;display:flex;align-items:center;gap:4px;}
.hbtn-add{background:var(--rust);color:white;}
.hbtn-exp{background:rgba(255,255,255,.15);color:white;}

.stats{display:flex;gap:8px;margin-top:14px;overflow-x:auto;scrollbar-width:none;}
.stats::-webkit-scrollbar{display:none;}
.stt{background:rgba(255,255,255,.12);border-radius:10px;padding:7px 12px;text-align:center;flex-shrink:0;min-width:58px;}
.stt-n{font-size:21px;font-weight:900;display:block;line-height:1;}
.stt-l{font-size:10px;opacity:.75;margin-top:2px;font-weight:500;}

/* â”€â”€ FILTER â”€â”€ */
.fbar{
  background:var(--parchment);
  border-bottom:2px solid var(--border);
  padding:10px 16px;
  position:sticky;top:116px;z-index:89;
}
.fbar-inner{display:flex;align-items:center;gap:10px;overflow-x:auto;scrollbar-width:none;}
.fbar-inner::-webkit-scrollbar{display:none;}
.fbar-label{font-size:11px;font-weight:700;color:var(--text-soft);white-space:nowrap;}
.fchip{white-space:nowrap;padding:7px 15px;border-radius:20px;border:2px solid var(--border);background:white;font-size:12px;font-weight:600;cursor:pointer;font-family:'Heebo',sans-serif;color:var(--text-mid);transition:all .15s;}
.fchip.on{background:var(--bark);color:white;border-color:var(--bark);}

/* â”€â”€ TABS â”€â”€ */
.subtabs{background:var(--linen);border-bottom:2px solid var(--border);position:sticky;top:158px;z-index:88;display:flex;}
.stab{flex:1;text-align:center;padding:11px 8px 9px;font-size:12px;font-weight:700;color:var(--text-soft);cursor:pointer;border-bottom:3px solid transparent;margin-bottom:-2px;transition:all .2s;}
.stab.on{color:var(--bark);border-bottom-color:var(--clay);}

/* â”€â”€ CONTENT â”€â”€ */
.content{padding:16px 16px 20px;max-width:640px;margin:0 auto;}

/* â”€â”€ SEARCH â”€â”€ */
.srch-wrap{position:relative;margin-bottom:16px;}
.srch-wrap input{width:100%;padding:13px 16px 13px 44px;border:2px solid var(--border);border-radius:var(--r);font-size:15px;font-family:'Heebo',sans-serif;background:white;color:var(--text);font-weight:500;}
.srch-wrap input:focus{outline:none;border-color:var(--clay);background:white;}
.srch-wrap input::placeholder{color:var(--text-soft);}
.srch-ic{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:18px;pointer-events:none;}

/* â”€â”€ SECTION HDR â”€â”€ */
.sec-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.sec-hdr h2{font-size:15px;font-weight:800;color:var(--bark);}
.sec-count{font-size:12px;color:var(--text-soft);background:var(--parchment);padding:3px 10px;border-radius:12px;font-weight:600;}

/* â”€â”€ VARIETY CARD â”€â”€ */
.vcard{
  background:white;
  border:2px solid var(--border);
  border-radius:var(--r);
  margin-bottom:14px;
  box-shadow:var(--shadow);
  overflow:hidden;
}

/* Photo strip - full width, tall */
.vcard-photo{
  width:100%;height:180px;
  overflow:hidden;background:var(--parchment);
  display:flex;align-items:center;justify-content:center;
  font-size:64px;cursor:pointer;position:relative;
}
.vcard-photo img{width:100%;height:100%;object-fit:cover;}
.photo-count-badge{
  position:absolute;bottom:10px;left:10px;
  background:rgba(30,20,10,.62);color:white;
  font-size:11px;font-weight:700;padding:4px 10px;border-radius:8px;
  backdrop-filter:blur(4px);
}
.photo-status-badge{
  position:absolute;top:10px;right:10px;
  padding:5px 12px;border-radius:20px;
  font-size:11px;font-weight:800;
  backdrop-filter:blur(8px);
}
.psb-flowering{background:rgba(74,107,42,.85);color:white;}
.psb-seeding{background:rgba(180,120,10,.85);color:white;}
.psb-dormant{background:rgba(100,90,80,.75);color:white;}
.psb-selected{background:rgba(40,80,140,.85);color:white;}

/* Card body */
.vcard-body{padding:14px 16px 12px;}
.vcard-name{font-size:16px;font-weight:900;color:var(--bark);margin-bottom:4px;line-height:1.25;}
.vcard-type{display:flex;align-items:center;gap:6px;margin-bottom:10px;}
.type-pill{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:700;}
.tp-ran{background:#fde8d8;color:#8B3010;}
.tp-swe{background:#ead5f0;color:#5B2D80;}
.tp-cal{background:#fef5e0;color:#8B6000;}
.tp-oth{background:#e8f0d8;color:#3A5A10;}
.color-swatch{width:16px;height:16px;border-radius:50%;border:2px solid rgba(0,0,0,.12);flex-shrink:0;}

.vcard-details{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px;}
.vcd-item{background:var(--cream);border-radius:8px;padding:7px 10px;}
.vcd-label{font-size:10px;font-weight:700;color:var(--text-soft);text-transform:uppercase;letter-spacing:.4px;}
.vcd-val{font-size:13px;font-weight:700;color:var(--text-mid);margin-top:2px;}

.stars{color:var(--amber);font-size:16px;letter-spacing:2px;}
.traits-row{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px;}
.trait-tag{background:var(--parchment);color:var(--bark-mid);font-size:11px;font-weight:600;padding:3px 9px;border-radius:8px;border:1px solid var(--border);}

/* Card actions */
.vcard-actions{
  display:flex;gap:8px;padding:10px 14px 12px;
  border-top:2px solid var(--linen);
  background:var(--parchment);
}
.cta{flex:1;padding:10px 6px;border:none;border-radius:10px;font-size:12px;font-weight:700;cursor:pointer;font-family:'Heebo',sans-serif;transition:opacity .15s;display:flex;align-items:center;justify-content:center;gap:4px;}
.cta:active{opacity:.75;}
.cta-bark{background:var(--bark);color:white;}
.cta-leaf{background:var(--leaf);color:white;}
.cta-sel{background:var(--sky);color:white;}
.cta-gold{background:var(--amber);color:white;}
.cta-moss{background:var(--moss);color:white;}
.cta-outline{background:white;color:var(--bark);border:2px solid var(--border);}

/* â”€â”€ EMPTY â”€â”€ */
.empty{text-align:center;padding:52px 20px;background:white;border-radius:var(--r);border:2px solid var(--border);}
.empty-ic{font-size:56px;margin-bottom:16px;}
.empty h3{font-size:16px;font-weight:800;color:var(--bark);margin-bottom:8px;}
.empty p{font-size:13px;color:var(--text-soft);line-height:1.7;}

/* â”€â”€ FAB â”€â”€ */
.fab{position:fixed;bottom:88px;left:18px;width:60px;height:60px;border-radius:30px;background:var(--rust);color:white;font-size:32px;display:flex;align-items:center;justify-content:center;border:none;box-shadow:var(--shadow-lg);cursor:pointer;z-index:200;}
.fab:active{transform:scale(.9);}

/* â”€â”€ BOTTOM NAV â”€â”€ */
.bnav{position:fixed;bottom:0;left:0;right:0;background:var(--parchment);display:flex;border-top:2px solid var(--border);padding:8px 0 12px;z-index:100;box-shadow:0 -4px 16px rgba(0,0,0,.10);}
.bni{flex:1;text-align:center;cursor:pointer;color:var(--text-soft);}
.bni.on{color:var(--bark);}
.bni-ic{font-size:22px;}
.bni-lb{font-size:10px;font-weight:700;margin-top:2px;}

/* â”€â”€ OVERLAY / SHEET â”€â”€ */
.overlay{display:none;position:fixed;inset:0;background:rgba(20,12,5,.5);z-index:500;align-items:flex-end;}
.overlay.on{display:flex;}
.sheet{background:var(--cream);border-radius:22px 22px 0 0;width:100%;max-height:94vh;overflow-y:auto;padding:20px 20px 36px;animation:up .28s ease;}
@keyframes up{from{transform:translateY(100%)}to{transform:translateY(0)}}
.sh-handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 20px;}
.sh-title{font-size:18px;font-weight:900;color:var(--bark);margin-bottom:20px;}

/* â”€â”€ FORM â”€â”€ */
.fg{margin-bottom:14px;}
.fl{display:block;font-size:11px;font-weight:700;color:var(--text-soft);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px;}
.fi,.fs,.ft{width:100%;padding:12px 14px;border:2px solid var(--border);border-radius:10px;font-size:15px;font-family:'Heebo',sans-serif;background:white;color:var(--text);}
.fi:focus,.fs:focus,.ft:focus{outline:none;border-color:var(--clay);}
.ft{min-height:72px;resize:vertical;}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}

/* cam */
.cam-zone{border:2px dashed var(--border);border-radius:12px;padding:22px;text-align:center;cursor:pointer;background:var(--parchment);}
.cam-zone:active{border-color:var(--clay);}
.cam-zone input{display:none;}
.cam-ic{font-size:40px;}
.cam-txt{font-size:12px;color:var(--text-soft);margin-top:8px;}
.pgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px;}
.pgi{aspect-ratio:1;border-radius:9px;overflow:hidden;position:relative;background:var(--parchment);}
.pgi img{width:100%;height:100%;object-fit:cover;}
.pgdel{position:absolute;top:4px;right:4px;background:rgba(0,0,0,.58);color:white;border:none;border-radius:50%;width:22px;height:22px;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;}

/* colors */
.crow{display:flex;flex-wrap:wrap;gap:10px;}
.csw{width:36px;height:36px;border-radius:50%;cursor:pointer;border:3px solid transparent;}
.csw.on{border-color:var(--bark);transform:scale(1.18);}

/* rating */
.rrow{display:flex;gap:6px;font-size:34px;cursor:pointer;}
.rstar{color:var(--border);}.rstar.on{color:var(--amber);}

/* gps */
.gps-row{display:flex;justify-content:space-between;align-items:center;background:white;border:2px solid var(--border);border-radius:10px;padding:11px 14px;}
.gps-lbl strong{display:block;font-size:13px;color:var(--text);margin-bottom:2px;}
.gps-lbl{font-size:12px;color:var(--text-soft);}
.gps-acc{font-size:10px;margin-top:2px;}
.gps-acc.good{color:var(--leaf);}.gps-acc.ok{color:var(--amber);}.gps-acc.bad{color:var(--rust);}
.gps-btn{background:var(--bark);color:white;border:none;border-radius:8px;padding:8px 13px;font-size:12px;font-weight:700;font-family:'Heebo',sans-serif;cursor:pointer;}

.divider{height:2px;background:var(--border);margin:16px 0;border-radius:1px;}

/* modal actions */
.macts{display:flex;gap:10px;margin-top:20px;}
.mact{flex:1;padding:14px;border:none;border-radius:10px;font-size:14px;font-weight:800;cursor:pointer;font-family:'Heebo',sans-serif;}
.mact-save{background:var(--bark);color:white;flex:2;}
.mact-cancel{background:var(--parchment);color:var(--bark-mid);border:2px solid var(--border);}

/* â”€â”€ DETAIL â”€â”€ */
.det-hero{width:100%;height:220px;border-radius:var(--r);overflow:hidden;background:var(--parchment);display:flex;align-items:center;justify-content:center;font-size:80px;margin-bottom:16px;position:relative;cursor:pointer;}
.det-hero img{width:100%;height:100%;object-fit:cover;}
.hero-dots{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);display:flex;gap:6px;}
.hdot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.5);}
.hdot.on{background:white;}
.det-name{font-size:18px;font-weight:900;color:var(--bark);}
.det-sub{font-size:12px;color:var(--text-soft);margin-top:3px;}
.icard{background:white;border:2px solid var(--border);border-radius:var(--r);padding:14px;margin-bottom:12px;}
.icard h3{font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.5px;color:var(--text-soft);margin-bottom:10px;}
.irow{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--linen);font-size:13px;}
.irow:last-child{border:none;}
.ikey{color:var(--text-soft);}
.ival{font-weight:700;color:var(--text-mid);}
.map-btn{display:flex;align-items:center;gap:8px;background:#e8f0f8;border:2px solid #b8d0e8;border-radius:10px;padding:10px 14px;font-size:13px;color:var(--sky);font-weight:700;text-decoration:none;margin-bottom:12px;}
.tl-item{display:flex;gap:10px;padding:7px 0;font-size:12px;}
.tl-dot{width:8px;height:8px;border-radius:50%;background:var(--leaf-mid);margin-top:4px;flex-shrink:0;}
.tl-date{font-size:10px;color:var(--text-soft);margin-top:2px;}

/* â”€â”€ FIELD VIEW â”€â”€ */
.loc-card{background:white;border:2px solid var(--border);border-radius:var(--r);padding:14px;margin-bottom:12px;box-shadow:var(--shadow);}
.loc-card h3{font-size:14px;font-weight:800;color:var(--bark);margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;}
.loc-item{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--linen);cursor:pointer;}
.loc-item:last-child{border:none;}
.loc-thumb{width:44px;height:44px;border-radius:8px;overflow:hidden;background:var(--parchment);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;}
.loc-thumb img{width:100%;height:100%;object-fit:cover;}

/* â”€â”€ SEASON â”€â”€ */
.sg{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:16px;}
.stile{background:white;border:2px solid var(--border);border-radius:var(--r);padding:15px;cursor:pointer;}
.stile h4{font-size:13px;font-weight:800;color:var(--bark);margin-bottom:6px;}
.sbar{height:7px;border-radius:4px;background:var(--linen);margin-bottom:5px;}
.sfill{height:100%;border-radius:4px;background:var(--leaf-mid);}

/* â”€â”€ TOAST â”€â”€ */
.toast{position:fixed;top:18px;left:50%;transform:translateX(-50%) translateY(-80px);background:var(--bark);color:white;padding:10px 20px;border-radius:20px;font-size:13px;font-weight:700;z-index:1000;transition:transform .25s;white-space:nowrap;box-shadow:var(--shadow-lg);}
.toast.on{transform:translateX(-50%) translateY(0);}
</style>
</head>
<body>

<!-- HEADER -->
<div class="hdr">
  <div class="hdr-top">
    <div>
      <h1><span class="leaf">ğŸŒ¿</span>××¢×§×‘ ×–× ×™× ××™×•×—×“×™×</h1>
      <div class="hdr-sub">×ª×™×¢×•×“ ×‘×©×˜×— Â· ×¦×™×œ×•× Â· GPS Â· ××¢×§×‘ ×¢×•× ×”</div>
    </div>
    <div class="hdr-btns">
      <button class="hbtn hbtn-exp" onclick="exportData()">ğŸ“¤</button>
      <button class="hbtn hbtn-add" onclick="openAdd()">ï¼‹ ×”×•×¡×£ ×–×Ÿ</button>
    </div>
  </div>
  <div class="stats">
    <div class="stt"><span class="stt-n" id="sTotal">0</span><span class="stt-l">×–× ×™×</span></div>
    <div class="stt"><span class="stt-n" id="sFlow">0</span><span class="stt-l">×¤×¨×™×—×”</span></div>
    <div class="stt"><span class="stt-n" id="sSel">0</span><span class="stt-l">× ×‘×—×¨×•</span></div>
    <div class="stt"><span class="stt-n" id="sSeed">0</span><span class="stt-l">×–×¨×¢×™×</span></div>
    <div class="stt"><span class="stt-n" id="sGps">0</span><span class="stt-l">GPS</span></div>
  </div>
</div>

<!-- FILTER -->
<div class="fbar">
  <div class="fbar-inner">
    <span class="fbar-label">×¡×•×’:</span>
    <button class="fchip on" data-f="all" onclick="setF('all',this)">×”×›×œ ğŸŒ¿</button>
    <button class="fchip" data-f="ranunculus" onclick="setF('ranunculus',this)">× ×•×¨×™×•×ª ğŸŒº</button>
    <button class="fchip" data-f="sweetpea" onclick="setF('sweetpea',this)">Sweet Pea ğŸŒ¸</button>
    <button class="fchip" data-f="calendula" onclick="setF('calendula',this)">Calendula ğŸŒ¼</button>
    <button class="fchip" data-f="selected" onclick="setF('selected',this)">â­ × ×‘×—×¨×•</button>
    <button class="fchip" data-f="flowering" onclick="setF('flowering',this)">ğŸŸ¢ ×¤×¨×™×—×”</button>
  </div>
</div>

<!-- TABS -->
<div class="subtabs">
  <div class="stab on" data-v="list" onclick="sw('list')">ğŸ“‹ ×–× ×™×</div>
  <div class="stab" data-v="field" onclick="sw('field')">ğŸ—º ×©×“×”</div>
  <div class="stab" data-v="season" onclick="sw('season')">ğŸ“… ×¢×•× ×”</div>
</div>

<!-- CONTENT -->
<div class="content">

  <div id="view-list">
    <div class="srch-wrap"><span class="srch-ic">ğŸ”</span><input id="srch" type="text" placeholder="×—×™×¤×•×© ×©×, ××™×§×•×, ×××¤×™×™×Ÿ..." oninput="renderList()"></div>
    <div class="sec-hdr"><h2>×–× ×™× ××ª×•×¢×“×™×</h2><span class="sec-count" id="cntLbl">0</span></div>
    <div id="listEl"></div>
  </div>

  <div id="view-field" style="display:none">
    <div class="sec-hdr"><h2>ğŸ—º ××¤×ª ×©×“×”</h2></div>
    <div id="fieldEl"></div>
  </div>

  <div id="view-season" style="display:none">
    <div class="sec-hdr"><h2>ğŸ“… ×¡×™×›×•× ×¢×•× ×”</h2><span class="sec-count" id="snLbl"></span></div>
    <div id="seasonEl"></div>
  </div>

</div>

<button class="fab" onclick="openAdd()">ï¼‹</button>

<div class="bnav">
  <div class="bni on" id="bn-list" onclick="sw('list')"><div class="bni-ic">ğŸ“‹</div><div class="bni-lb">×–× ×™×</div></div>
  <div class="bni" id="bn-field" onclick="sw('field')"><div class="bni-ic">ğŸ—º</div><div class="bni-lb">×©×“×”</div></div>
  <div class="bni" id="bn-season" onclick="sw('season')"><div class="bni-ic">ğŸ“…</div><div class="bni-lb">×¢×•× ×”</div></div>
</div>

<div class="toast" id="toast"></div>

<!-- ADD/EDIT MODAL -->
<div class="overlay" id="addModal" onclick="bgc(event,'addModal')">
  <div class="sheet">
    <div class="sh-handle"></div>
    <div class="sh-title" id="mTitle">ğŸŒ± ×”×•×¡×¤×ª ×–×Ÿ ×—×“×©</div>

    <div class="fg">
      <label class="fl">ğŸ“· ×ª××•× ×•×ª â€” ×¦×œ× ×¢×›×©×™×•!</label>
      <div class="cam-zone" onclick="document.getElementById('camIn').click()">
        <div class="cam-ic">ğŸ“·</div>
        <div class="cam-txt">×œ×—×¥ ×œ×¦×œ× ××”××¦×œ××”<br><small>××• ×‘×—×¨ ××”×’×œ×¨×™×” (×¢×“ 5)</small></div>
        <input type="file" id="camIn" accept="image/*" multiple onchange="addPh(event)">
      </div>
      <div class="pgrid" id="pgrid"></div>
    </div>

    <div class="divider"></div>

    <div class="fg"><label class="fl">×©× ×”×–×Ÿ / ×§×•×“</label><input class="fi" id="fName" type="text" placeholder="× ×•×¨×™×” ×•×¨×•×“×” ×©×•×¨×” 4 / R-007"></div>

    <div class="grid2">
      <div class="fg"><label class="fl">×¡×•×’</label>
        <select class="fs" id="fType">
          <option value="ranunculus">× ×•×¨×™×•×ª ğŸŒº</option>
          <option value="sweetpea">Sweet Pea ğŸŒ¸</option>
          <option value="calendula">Calendula ğŸŒ¼</option>
          <option value="other">××—×¨ ğŸŒ¿</option>
        </select>
      </div>
      <div class="fg"><label class="fl">×¡×˜×˜×•×¡</label>
        <select class="fs" id="fStatus">
          <option value="flowering">ğŸŸ¢ ×‘×¤×¨×™×—×”</option>
          <option value="seeding">ğŸŸ¡ ×‘×–×¨×¢×™×</option>
          <option value="dormant">âšª ×¨×“×•×</option>
          <option value="selected">ğŸ”µ × ×‘×—×¨</option>
        </select>
      </div>
    </div>

    <div class="fg">
      <label class="fl">ğŸ“ ××™×§×•× GPS</label>
      <div class="gps-row">
        <div class="gps-lbl"><strong id="gpsLbl">×œ× × ×§×œ×˜</strong><div class="gps-acc" id="gpsAcc"></div></div>
        <button class="gps-btn" id="gpsBtn" onclick="grabGPS()">ğŸ“¡ ×§×œ×•×˜ GPS</button>
      </div>
      <input class="fi" id="fLoc" type="text" placeholder="×ª×™××•×¨ ×™×“× ×™: ×©×•×¨×” 4, ×¢××“×” 12..." style="margin-top:8px">
    </div>

    <div class="fg">
      <label class="fl">×¦×‘×¢ ×”×¤×¨×—</label>
      <div class="crow">
        <div class="csw on" style="background:#FF6B9D" data-c="#FF6B9D" onclick="pickC(this)"></div>
        <div class="csw" style="background:#E74C3C" data-c="#E74C3C" onclick="pickC(this)"></div>
        <div class="csw" style="background:#FF8C42" data-c="#FF8C42" onclick="pickC(this)"></div>
        <div class="csw" style="background:#FFD700" data-c="#FFD700" onclick="pickC(this)"></div>
        <div class="csw" style="background:#fff;border-color:#ccc" data-c="#FFFFFF" onclick="pickC(this)"></div>
        <div class="csw" style="background:#F5CBA7" data-c="#F5CBA7" onclick="pickC(this)"></div>
        <div class="csw" style="background:#D7BDE2" data-c="#D7BDE2" onclick="pickC(this)"></div>
        <div class="csw" style="background:#9B59B6" data-c="#9B59B6" onclick="pickC(this)"></div>
        <div class="csw" style="background:#C0392B" data-c="#C0392B" onclick="pickC(this)"></div>
        <div class="csw" style="background:#2ECC71" data-c="#2ECC71" onclick="pickC(this)"></div>
        <div class="csw" style="background:#1ABC9C" data-c="#1ABC9C" onclick="pickC(this)"></div>
        <div class="csw" style="background:#5D4037" data-c="#5D4037" onclick="pickC(this)"></div>
      </div>
    </div>

    <div class="fg"><label class="fl">×“×™×¨×•×’</label>
      <div class="rrow">
        <span class="rstar" data-r="1" onclick="pickR(1)">â˜…</span>
        <span class="rstar" data-r="2" onclick="pickR(2)">â˜…</span>
        <span class="rstar" data-r="3" onclick="pickR(3)">â˜…</span>
        <span class="rstar" data-r="4" onclick="pickR(4)">â˜…</span>
        <span class="rstar" data-r="5" onclick="pickR(5)">â˜…</span>
      </div>
    </div>

    <div class="fg"><label class="fl">×××¤×™×™× ×™× ××™×•×—×“×™×</label><input class="fi" id="fTraits" type="text" placeholder="×¨×™×— ×—×–×§, ×’×‘×¢×•×œ ××¨×•×š, ×¢××™×“ ×—×•×..."></div>
    <div class="fg"><label class="fl">×”×¢×¨×•×ª</label><textarea class="ft" id="fNotes" placeholder="×”×©×•×•××” ×œ×–× ×™× ××—×¨×™×, ×ª×¦×¤×™×•×ª..."></textarea></div>

    <div class="macts">
      <button class="mact mact-save" onclick="saveV()">ğŸŒ± ×©××™×¨×”</button>
      <button class="mact mact-cancel" onclick="closeM('addModal')">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<!-- DETAIL MODAL -->
<div class="overlay" id="detModal" onclick="bgc(event,'detModal')">
  <div class="sheet" id="detSheet"></div>
</div>

<script>
let DB=[],filt='all',editId=null,pC='#FF6B9D',pR=0,nPh=[],gpsC=null,dIdx=0;
const TL={ranunculus:'× ×•×¨×™×•×ª',sweetpea:'Sweet Pea',calendula:'Calendula',other:'××—×¨'};
const TE={ranunculus:'ğŸŒº',sweetpea:'ğŸŒ¸',calendula:'ğŸŒ¼',other:'ğŸŒ¿'};
const SL={flowering:'×‘×¤×¨×™×—×”',seeding:'×‘×–×¨×¢×™×',dormant:'×¨×“×•×',selected:'× ×‘×—×¨'};
const SE={flowering:'ğŸŸ¢',seeding:'ğŸŸ¡',dormant:'âšª',selected:'ğŸ”µ'};
const TC={ranunculus:'tp-ran',sweetpea:'tp-swe',calendula:'tp-cal',other:'tp-oth'};
const PSB={flowering:'psb-flowering',seeding:'psb-seeding',dormant:'psb-dormant',selected:'psb-selected'};

async function load(){try{const r=await window.storage.get('vdb_v5');if(r?.value)DB=JSON.parse(r.value);}catch(e){DB=[];}}
async function save(){try{await window.storage.set('vdb_v5',JSON.stringify(DB));}catch(e){}}

async function boot(){
  await load();
  if(!DB.length)DB=[
    {id:1001,name:'× ×•×¨×™×” ×•×¨×•×“×” ×¢××•×§×” â€” ×©×•×¨×” 4',type:'ranunculus',color:'#FF6B9D',locText:'×©×•×¨×” 4, ×¢××“×” 7',gps:null,status:'selected',rating:5,traits:'×¢×œ×™ ×›×•×ª×¨×ª ×›×¤×•×œ×™×, ×¨×™×— ×¢×–, ×’×‘×¢×•×œ 60cm',notes:'×¦×‘×¢ ×™×™×—×•×“×™, ×©××•×¨ ×œ×¤×§×¢×ª.',photos:[],created:today(),updated:today(),season:getSeason(),log:[{d:today(),n:'×ª×•×¢×“ ğŸŒ±'},{d:today(),n:'â­ × ×‘×—×¨'}]},
    {id:1002,name:'Sweet Pea ×œ×‘×Ÿ ×¨×™×—× ×™ â€” ×’×•×© B',type:'sweetpea',color:'#FFFFFF',locText:'×’×•×© B, ×©×•×¨×” 2',gps:null,status:'seeding',rating:4,traits:'×¨×™×— ××™×•×—×“, ×’×‘×¢×•×œ ××¨×•×š',notes:'×”×¨×™×—× ×™ ×‘×™×•×ª×¨ ×”×©× ×”.',photos:[],created:today(),updated:today(),season:getSeason(),log:[{d:today(),n:'×ª×•×¢×“ ğŸŒ±'}]}
  ];
  document.getElementById('snLbl').textContent='×¢×•× ×” '+getSeason();
  renderAll();
}

function renderAll(){updateStats();renderList();renderField();renderSeason();}

function updateStats(){
  document.getElementById('sTotal').textContent=DB.length;
  document.getElementById('sFlow').textContent=DB.filter(v=>v.status==='flowering').length;
  document.getElementById('sSel').textContent=DB.filter(v=>v.status==='selected').length;
  document.getElementById('sSeed').textContent=DB.filter(v=>v.status==='seeding').length;
  document.getElementById('sGps').textContent=DB.filter(v=>v.gps).length;
}

function getFilt(){
  const q=document.getElementById('srch').value.toLowerCase();
  return DB.filter(v=>{
    const mf=filt==='all'?true:filt==='selected'?v.status==='selected':filt==='flowering'?v.status==='flowering':v.type===filt;
    const ms=!q||v.name.toLowerCase().includes(q)||(v.traits||'').toLowerCase().includes(q)||(v.locText||'').toLowerCase().includes(q);
    return mf&&ms;
  });
}

function renderList(){
  const el=document.getElementById('listEl'),data=getFilt();
  document.getElementById('cntLbl').textContent=data.length+' ×–× ×™×';
  if(!data.length){el.innerHTML=`<div class="empty"><div class="empty-ic">${DB.length?'ğŸ”':'ğŸŒ±'}</div><h3>${DB.length?'×œ× × ××¦××•':'××™×Ÿ ×–× ×™× ×¢×“×™×™×Ÿ'}</h3><p>${DB.length?'× ×¡×” ×¡×™× ×•×Ÿ ××—×¨':'×œ×—×¥ "+ ×”×•×¡×£ ×–×Ÿ" ×œ×”×ª×—×œ×”'}</p></div>`;return;}
  el.innerHTML=data.map(v=>{
    const bgCol=v.color&&v.color!=='#FFFFFF'?v.color+'33':'#F2EAD8';
    const photoHtml=v.photos?.length
      ?`<div class="vcard-photo" onclick="openDet(${v.id})"><img src="${v.photos[0]}">${v.photos.length>1?`<div class="photo-count-badge">ğŸ“· ${v.photos.length} ×ª××•× ×•×ª</div>`:''}<div class="photo-status-badge ${PSB[v.status]}">${SE[v.status]} ${SL[v.status]}</div></div>`
      :`<div class="vcard-photo" style="background:${bgCol}" onclick="openDet(${v.id})"><span style="font-size:56px">${TE[v.type]}</span><div class="photo-status-badge ${PSB[v.status]}">${SE[v.status]} ${SL[v.status]}</div></div>`;
    const stars='â˜…'.repeat(v.rating||0)+'â˜†'.repeat(5-(v.rating||0));
    const loc=v.gps?`ğŸ“¡ ${v.locText||cs(v.gps)}`:v.locText?`ğŸ“ ${v.locText}`:'ğŸ“ ×œ×œ× ××™×§×•×';
    const traitTags=(v.traits||'').split(',').filter(Boolean).slice(0,3).map(t=>`<span class="trait-tag">${t.trim()}</span>`).join('');
    return `
    <div class="vcard">
      ${photoHtml}
      <div class="vcard-body">
        <div class="vcard-name">${v.name}</div>
        <div class="vcard-type">
          <span class="type-pill ${TC[v.type]}">${TE[v.type]} ${TL[v.type]}</span>
          <span class="color-swatch" style="background:${v.color||'#ccc'}"></span>
          <span class="stars" style="font-size:14px">${stars}</span>
        </div>
        <div class="vcard-details">
          <div class="vcd-item"><div class="vcd-label">××™×§×•×</div><div class="vcd-val" style="font-size:12px">${loc}</div></div>
          <div class="vcd-item"><div class="vcd-label">×¢×“×›×•×Ÿ</div><div class="vcd-val" style="font-size:12px">${v.updated}</div></div>
        </div>
        ${traitTags?`<div class="traits-row">${traitTags}</div>`:''}
      </div>
      <div class="vcard-actions">
        <button class="cta cta-outline" onclick="openDet(${v.id})">ğŸ“‹ ×¤×¨×˜×™×</button>
        <button class="cta cta-bark" onclick="openEdit(${v.id})">âœï¸ ×¢×¨×™×›×”</button>
        <button class="cta ${v.status==='selected'?'cta-gold':'cta-sel'}" onclick="togSel(${v.id})">${v.status==='selected'?'âœ…':'â­'}</button>
        <button class="cta cta-moss" onclick="qNote(${v.id})">ğŸ“</button>
      </div>
    </div>`;
  }).join('');
}

function renderField(){
  const el=document.getElementById('fieldEl');
  if(!DB.length){el.innerHTML='<div class="empty"><div class="empty-ic">ğŸ—º</div><h3>××™×Ÿ ×–× ×™×</h3></div>';return;}
  const byL={};DB.forEach(v=>{const k=v.locText||(v.gps?cs(v.gps):'×œ×œ× ××™×§×•×');if(!byL[k])byL[k]=[];byL[k].push(v);});
  el.innerHTML=Object.entries(byL).map(([loc,vs])=>`
    <div class="loc-card">
      <h3><span>ğŸ“ ${loc}</span>${vs[0]?.gps?`<a href="https://maps.google.com/?q=${vs[0].gps.lat},${vs[0].gps.lng}" target="_blank" style="font-size:12px;color:var(--sky);font-weight:600;text-decoration:none">ğŸ—º ××¤×”</a>`:''}
      </h3>
      ${vs.map(v=>`<div class="loc-item" onclick="openDet(${v.id})">
        <div class="loc-thumb">${v.photos?.length?`<img src="${v.photos[0]}">`:`${TE[v.type]}`}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:14px;font-weight:800;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--bark)">${v.name}</div>
          <div style="font-size:11px;color:var(--text-soft);margin-top:2px">${SE[v.status]} ${SL[v.status]} Â· ${'â˜…'.repeat(v.rating||0)}</div>
        </div>
      </div>`).join('')}
    </div>`).join('');
}

function renderSeason(){
  const el=document.getElementById('seasonEl');
  const types=['ranunculus','sweetpea','calendula'].filter(t=>DB.some(v=>v.type===t));
  if(!types.length){el.innerHTML='<div class="empty"><div class="empty-ic">ğŸ“…</div><h3>××™×Ÿ × ×ª×•× ×™×</h3></div>';return;}
  el.innerHTML=`<div class="sg">${types.map(t=>{
    const arr=DB.filter(v=>v.type===t),sel=arr.filter(v=>v.status==='selected').length,pct=Math.round(sel/arr.length*100);
    return `<div class="stile" onclick="setF('${t}',null);sw('list')">
      <h4>${TE[t]} ${TL[t]}</h4>
      <div style="font-size:28px;font-weight:900;color:var(--bark)">${arr.length}</div>
      <div style="font-size:11px;color:var(--text-soft);margin-bottom:8px">×–× ×™×</div>
      <div class="sbar"><div class="sfill" style="width:${pct}%"></div></div>
      <div style="font-size:10px;color:var(--text-soft)">${sel} × ×‘×—×¨×• Â· ${pct}%</div>
    </div>`;}).join('')}</div>
  <div class="icard"><h3>ğŸ“Š ×¡×™×›×•× ×¢×•× ×”</h3>
  ${[['×¡×”×´×› ×–× ×™×',DB.length],['× ×‘×—×¨×• ×œ×©××™×¨×”',DB.filter(v=>v.status==='selected').length],['×‘×¤×¨×™×—×”',DB.filter(v=>v.status==='flowering').length],['×‘×”×™×¦×¨×•×ª ×–×¨×¢×™×',DB.filter(v=>v.status==='seeding').length],['×¢× GPS',DB.filter(v=>v.gps).length],['×¢× ×ª××•× ×•×ª',DB.filter(v=>v.photos?.length).length],['×“×™×¨×•×’ ×××•×¦×¢',DB.length?(DB.reduce((a,v)=>a+(v.rating||0),0)/DB.length).toFixed(1)+' â˜…':'â€”']].map(([k,v])=>`<div class="irow"><span class="ikey">${k}</span><span class="ival">${v}</span></div>`).join('')}</div>`;
}

function openDet(id){
  const v=DB.find(v=>v.id===id);if(!v)return;dIdx=0;
  const stars='â˜…'.repeat(v.rating||0)+'â˜†'.repeat(5-(v.rating||0));
  const bgCol=v.color&&v.color!=='#FFFFFF'?v.color+'33':'#F2EAD8';
  const hero=v.photos?.length
    ?`<div class="det-hero" onclick="nHero(${id})" id="hero-${id}"><img src="${v.photos[0]}" id="hi-${id}">${v.photos.length>1?`<div class="hero-dots">${v.photos.map((_,i)=>`<div class="hdot${i===0?' on':''}"></div>`).join('')}</div>`:''}</div>`
    :`<div class="det-hero" style="background:${bgCol}">${TE[v.type]}</div>`;
  const log=(v.log||[]).slice().reverse().map(l=>`<div class="tl-item"><div class="tl-dot"></div><div><div>${l.n}</div><div class="tl-date">${l.d}</div></div></div>`).join('');
  const mapsHtml=v.gps?`<a class="map-btn" href="https://maps.google.com/?q=${v.gps.lat},${v.gps.lng}" target="_blank">ğŸ—º ×¤×ª×— ×‘-Google Maps <span style="font-weight:400;font-size:11px">(${cs(v.gps)})</span></a>`:'';
  document.getElementById('detSheet').innerHTML=`
    <div class="sh-handle"></div>${hero}
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px">
      <div><div class="det-name">${v.name}</div><div class="det-sub">${TE[v.type]} ${TL[v.type]}</div>
      <div class="stars" style="font-size:20px;margin-top:4px">${stars}</div></div>
      <span style="background:var(--parchment);border:2px solid var(--border);border-radius:12px;padding:5px 12px;font-size:12px;font-weight:700;color:var(--bark-mid)">${SE[v.status]} ${SL[v.status]}</span>
    </div>
    ${mapsHtml}
    <div class="icard"><h3>×¤×¨×˜×™×</h3>
      <div class="irow"><span class="ikey">××™×§×•×</span><span class="ival">${v.locText||'â€”'}</span></div>
      <div class="irow"><span class="ikey">×¦×‘×¢</span><span class="ival"><span style="display:inline-block;width:13px;height:13px;border-radius:50%;background:${v.color||'#ccc'};border:1.5px solid #ddd;vertical-align:middle;margin-left:4px"></span>${v.color||'â€”'}</span></div>
      <div class="irow"><span class="ikey">×¢×•× ×”</span><span class="ival">${v.season||'â€”'}</span></div>
      <div class="irow"><span class="ikey">×¢×•×“×›×Ÿ</span><span class="ival">${v.updated}</span></div>
      <div class="irow"><span class="ikey">×ª××•× ×•×ª</span><span class="ival">${v.photos?.length||0} ğŸ“·</span></div>
    </div>
    ${v.traits?`<div class="icard"><h3>×××¤×™×™× ×™×</h3><div class="traits-row">${v.traits.split(',').map(t=>`<span class="trait-tag">${t.trim()}</span>`).join('')}</div></div>`:''}
    ${v.notes?`<div class="icard"><h3>×”×¢×¨×•×ª</h3><div style="font-size:13px;line-height:1.7;color:var(--text-mid)">${v.notes}</div></div>`:''}
    ${log?`<div class="icard"><h3>×”×™×¡×˜×•×¨×™×”</h3>${log}</div>`:''}
    <div style="display:flex;gap:10px;margin-top:16px">
      <button class="mact mact-save" onclick="openEdit(${id});closeM('detModal')" style="flex:2">âœï¸ ×¢×¨×™×›×”</button>
      <button class="mact" style="background:#fde8d8;color:var(--rust);border:none" onclick="delV(${id});closeM('detModal')">ğŸ—‘</button>
      <button class="mact mact-cancel" onclick="closeM('detModal')">×¡×’×•×¨</button>
    </div>`;
  document.getElementById('detModal').classList.add('on');
}

function nHero(id){
  const v=DB.find(v=>v.id===id);if(!v?.photos||v.photos.length<2)return;
  dIdx=(dIdx+1)%v.photos.length;
  document.getElementById(`hi-${id}`).src=v.photos[dIdx];
  document.querySelectorAll(`#hero-${id} .hdot`).forEach((d,i)=>d.classList.toggle('on',i===dIdx));
}

function openAdd(){editId=null;pC='#FF6B9D';pR=0;nPh=[];gpsC=null;document.getElementById('mTitle').textContent='ğŸŒ± ×”×•×¡×¤×ª ×–×Ÿ ×—×“×©';['fName','fLoc','fTraits','fNotes'].forEach(id=>document.getElementById(id).value='');document.getElementById('fType').value='ranunculus';document.getElementById('fStatus').value='flowering';resetUI();document.getElementById('addModal').classList.add('on');}
function openEdit(id){const v=DB.find(v=>v.id===id);if(!v)return;editId=id;pC=v.color||'#FF6B9D';pR=v.rating||0;nPh=v.photos?[...v.photos]:[];gpsC=v.gps||null;document.getElementById('mTitle').textContent='âœï¸ ×¢×¨×™×›×ª ×–×Ÿ';document.getElementById('fName').value=v.name;document.getElementById('fType').value=v.type;document.getElementById('fLoc').value=v.locText||'';document.getElementById('fStatus').value=v.status;document.getElementById('fTraits').value=v.traits||'';document.getElementById('fNotes').value=v.notes||'';resetUI();document.querySelector(`[data-c="${pC}"]`)?.classList.add('on');pickR(pR);renderPG();updateGUI();document.getElementById('addModal').classList.add('on');}

function resetUI(){document.querySelectorAll('.csw').forEach(s=>s.classList.remove('on'));document.querySelector(`[data-c="${pC}"]`)?.classList.add('on');document.querySelectorAll('.rstar').forEach(s=>s.classList.remove('on'));document.getElementById('pgrid').innerHTML='';document.getElementById('gpsLbl').textContent='×œ× × ×§×œ×˜';document.getElementById('gpsAcc').textContent='';document.getElementById('gpsAcc').className='gps-acc';}
function updateGUI(){if(gpsC){document.getElementById('gpsLbl').textContent=cs(gpsC);document.getElementById('gpsAcc').className='gps-acc good';document.getElementById('gpsAcc').textContent=`âœ… ×“×™×•×§: ${gpsC.acc||'?'}××³`;}else{document.getElementById('gpsLbl').textContent='×œ× × ×§×œ×˜';document.getElementById('gpsAcc').textContent='';}}
function pickC(el){document.querySelectorAll('.csw').forEach(s=>s.classList.remove('on'));el.classList.add('on');pC=el.dataset.c;}
function pickR(v){pR=v;document.querySelectorAll('.rstar').forEach(s=>s.classList.toggle('on',parseInt(s.dataset.r)<=v));}
function addPh(e){Array.from(e.target.files).slice(0,5-nPh.length).forEach(f=>{const r=new FileReader();r.onload=ev=>{nPh.push(ev.target.result);renderPG();};r.readAsDataURL(f);});}
function renderPG(){document.getElementById('pgrid').innerHTML=nPh.map((p,i)=>`<div class="pgi"><img src="${p}"><button class="pgdel" onclick="rmPh(${i})">âœ•</button></div>`).join('');}
function rmPh(i){nPh.splice(i,1);renderPG();}

function grabGPS(){
  const btn=document.getElementById('gpsBtn');
  btn.textContent='â³ ×××ª×¨ ××™×§×•×...';

  if(!navigator.geolocation){
    showToast('âš ï¸ GPS ×œ× × ×ª××š ×‘××›×©×™×¨');
    btn.textContent='ğŸ“¡ ×§×œ×•×˜ GPS';
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      gpsC={
        lat:pos.coords.latitude.toFixed(6),
        lng:pos.coords.longitude.toFixed(6),
        acc:Math.round(pos.coords.accuracy)
      };
      updateGUI();
      btn.textContent='ğŸ“¡ ×§×œ×•×˜ ×©×•×‘';
      showToast('ğŸ“ GPS × ×§×œ×˜!');
    },
    (err)=>{
      document.getElementById('gpsAcc').className='gps-acc bad';
      document.getElementById('gpsAcc').textContent='âŒ ×‘×“×•×§ ×”×¨×©××•×ª ××™×§×•× ×‘×“×¤×“×¤×Ÿ';
      btn.textContent='ğŸ“¡ × ×¡×” ×©×•×‘';
      showToast('âš ï¸ ×™×© ×œ××©×¨ ×”×¨×©××•×ª ××™×§×•× ×‘×”×’×“×¨×•×ª');
    },
    {enableHighAccuracy:true,timeout:15000,maximumAge:0}
  );
}

async function saveV(){const name=document.getElementById('fName').value.trim();if(!name){showToast('âš ï¸ ×—×¡×¨ ×©×');return;}const now=today();if(editId){const idx=DB.findIndex(v=>v.id===editId);if(idx>=0){const old=DB[idx],ns=document.getElementById('fStatus').value;DB[idx]={...old,name,type:document.getElementById('fType').value,color:pC,locText:document.getElementById('fLoc').value.trim(),gps:gpsC,status:ns,rating:pR,traits:document.getElementById('fTraits').value.trim(),notes:document.getElementById('fNotes').value.trim(),photos:nPh,updated:now};if(old.status!==ns){DB[idx].log=DB[idx].log||[];DB[idx].log.push({d:now,n:`×¡×˜×˜×•×¡ â†’ ${SL[ns]}`});}if(gpsC&&!old.gps){DB[idx].log=DB[idx].log||[];DB[idx].log.push({d:now,n:`ğŸ“ GPS: ${cs(gpsC)}`});}}showToast('âœ… ×¢×•×“×›×Ÿ');}else{DB.unshift({id:Date.now(),name,type:document.getElementById('fType').value,color:pC,locText:document.getElementById('fLoc').value.trim(),gps:gpsC,status:document.getElementById('fStatus').value,rating:pR,traits:document.getElementById('fTraits').value.trim(),notes:document.getElementById('fNotes').value.trim(),photos:nPh,created:now,updated:now,season:getSeason(),log:[{d:now,n:'×ª×•×¢×“ ×œ×¨××©×•× ×” ğŸŒ±'},...(gpsC?[{d:now,n:`ğŸ“ GPS: ${cs(gpsC)}`}]:[])]});showToast('âœ… ×–×Ÿ ×—×“×© × ×•×¡×£!');}await save();closeM('addModal');renderAll();}
async function togSel(id){const v=DB.find(v=>v.id===id);if(!v)return;const was=v.status==='selected';v.status=was?'flowering':'selected';v.updated=today();v.log=v.log||[];v.log.push({d:today(),n:was?'×”×•×¡×¨ ×× ×‘×—×¨×™×':'â­ × ×‘×—×¨ ×œ×©××™×¨×”'});await save();renderAll();showToast(was?'â†©ï¸ ×”×•×¡×¨':'â­ × ×‘×—×¨!');}
async function delV(id){if(!confirm('×œ××—×•×§?'))return;DB=DB.filter(v=>v.id!==id);await save();renderAll();showToast('ğŸ—‘ × ××—×§');}
async function qNote(id){const note=prompt('×”×¢×¨×” ××”×™×¨×”:');if(!note?.trim())return;const v=DB.find(v=>v.id===id);if(!v)return;v.log=v.log||[];v.log.push({d:today(),n:note.trim()});v.updated=today();await save();renderAll();showToast('ğŸ“ × ×©××¨');}

function setF(f,btn){filt=f;document.querySelectorAll('.fchip[data-f]').forEach(c=>c.classList.remove('on'));if(btn)btn.classList.add('on');else document.querySelector(`.fchip[data-f="${f}"]`)?.classList.add('on');renderList();}
function sw(tab){['list','field','season'].forEach(t=>{document.getElementById(`view-${t}`).style.display=t===tab?'block':'none';});document.querySelectorAll('[data-v]').forEach(el=>el.classList.toggle('on',el.dataset.v===tab));document.querySelectorAll('.bni').forEach(n=>n.classList.remove('on'));document.getElementById(`bn-${tab}`)?.classList.add('on');}
function closeM(id){document.getElementById(id).classList.remove('on');}
function bgc(e,id){if(e.target===document.getElementById(id))closeM(id);}
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('on');setTimeout(()=>t.classList.remove('on'),2200);}
function exportData(){const b=new Blob([JSON.stringify(DB,null,2)],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=`varieties_${today()}.json`;a.click();showToast('ğŸ“¤ ×™×•×¦×');}
function today(){return new Date().toISOString().split('T')[0];}
function getSeason(){const n=new Date(),y=n.getFullYear(),m=n.getMonth()+1;return m>=9?`${y}-${y+1}`:`${y-1}-${y}`;}
function cs(g){return g?`${g.lat}, ${g.lng}`:''}

boot();
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js');
  });
}
</script>

</body>
</html>
