<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>××¢×§×‘ ×–× ×™× | ×©×“×”</title>
<link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;500;600;700;800&family=Heebo:wght@700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --bark:      #3E2A1C;
  --bark-mid:  #5A4033;
  --soil:      #7A5C3A;
  --clay:      #9F7A4A;
  --sand:      #C8A87A;
  --linen:     #F4EBD8;
  --cream:     #FAF7F0;
  --parchment: #F0E5D0;
  --leaf:      #486B2A;
  --leaf-mid:  #689040;
  --leaf-light:#9DC062;
  --moss:      #8A9E55;
  --rust:      #B85C2A;
  --amber:     #D4890A;
  --sky:       #2E5F7A;
  --text:      #1E1410;
  --text-mid:  #4A3828;
  --text-soft: #7A6250;
  --border:    #D8C8A8;
  --shadow:    0 4px 14px rgba(59,42,26,.10);
  --shadow-lg: 0 10px 32px rgba(59,42,26,.18);
  --r:         16px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{font-family:'Assistant',sans-serif;background:var(--cream);color:var(--text);min-height:100vh;padding-bottom:84px;line-height:1.5;}

/* â”€â”€ HEADER â”€â”€ */
.hdr{
  background: linear-gradient(155deg, #2A1A0F 0%, var(--bark) 40%, var(--bark-mid) 80%, #6A4A35 100%);
  padding:20px 18px 18px; color:white;
  position:sticky;top:0;z-index:100;
  box-shadow:0 6px 24px rgba(0,0,0,.32);
}
.hdr-top{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;}
.hdr h1{font-family:'Heebo',sans-serif;font-size:clamp(17px,5vw,24px);font-weight:900;line-height:1.15;letter-spacing:-.3px;}
.hdr h1 .ic{font-size:1.2em;margin-left:8px;filter:drop-shadow(0 2px 4px rgba(0,0,0,.2));}
.hdr-sub{font-size:11px;opacity:.72;margin-top:4px;font-weight:500;letter-spacing:.2px;}
.hdr-btns{display:flex;gap:7px;flex-shrink:0;}
.hbtn{border:none;border-radius:10px;padding:9px 14px;font-size:12px;font-weight:700;font-family:'Heebo',sans-serif;cursor:pointer;display:flex;align-items:center;gap:5px;box-shadow:0 2px 8px rgba(0,0,0,.18);}
.hbtn-add{background:linear-gradient(135deg, var(--rust) 0%, #D4750A 100%);color:white;}
.hbtn-exp{background:rgba(255,255,255,.16);color:white;backdrop-filter:blur(4px);}

.stats{display:flex;gap:9px;margin-top:16px;overflow-x:auto;scrollbar-width:none;}
.stats::-webkit-scrollbar{display:none;}
.stt{background:rgba(255,255,255,.13);border-radius:12px;padding:8px 13px;text-align:center;flex-shrink:0;min-width:62px;backdrop-filter:blur(6px);box-shadow:inset 0 1px 2px rgba(255,255,255,.15);}
.stt-n{font-size:23px;font-weight:900;display:block;line-height:1;font-family:'Heebo',sans-serif;}
.stt-l{font-size:10px;opacity:.78;margin-top:3px;font-weight:600;letter-spacing:.3px;}

/* â”€â”€ FILTER â”€â”€ */
.fbar{
  background:linear-gradient(to bottom, var(--parchment) 0%, var(--linen) 100%);
  border-bottom:2px solid var(--border);
  padding:11px 16px;
  position:sticky;top:120px;z-index:89;
  box-shadow:0 2px 8px rgba(0,0,0,.04);
}
.fbar-inner{display:flex;align-items:center;gap:10px;overflow-x:auto;scrollbar-width:none;}
.fbar-inner::-webkit-scrollbar{display:none;}
.fbar-label{font-size:11px;font-weight:800;color:var(--text-mid);white-space:nowrap;letter-spacing:.4px;font-family:'Heebo',sans-serif;}
.fchip{white-space:nowrap;padding:8px 16px;border-radius:22px;border:2px solid var(--border);background:white;font-size:12px;font-weight:700;cursor:pointer;font-family:'Heebo',sans-serif;color:var(--text-mid);transition:all .2s;box-shadow:0 2px 6px rgba(0,0,0,.06);}
.fchip:active{transform:scale(.96);}
.fchip.on{background:var(--bark);color:white;border-color:var(--bark);box-shadow:0 4px 10px rgba(62,42,28,.28);}

/* â”€â”€ TABS â”€â”€ */
.subtabs{background:var(--linen);border-bottom:2px solid var(--border);position:sticky;top:167px;z-index:88;display:flex;}
.stab{flex:1;text-align:center;padding:12px 8px 10px;font-size:13px;font-weight:800;color:var(--text-soft);cursor:pointer;border-bottom:3px solid transparent;margin-bottom:-2px;transition:all .2s;font-family:'Heebo',sans-serif;}
.stab.on{color:var(--bark);border-bottom-color:var(--clay);}

/* â”€â”€ CONTENT â”€â”€ */
.content{padding:18px 16px 24px;max-width:680px;margin:0 auto;}

/* â”€â”€ SEARCH â”€â”€ */
.srch-wrap{position:relative;margin-bottom:18px;}
.srch-wrap input{width:100%;padding:14px 16px 14px 46px;border:2px solid var(--border);border-radius:var(--r);font-size:15px;font-family:'Assistant',sans-serif;background:white;color:var(--text);font-weight:500;box-shadow:0 2px 8px rgba(0,0,0,.06);}
.srch-wrap input:focus{outline:none;border-color:var(--clay);background:white;box-shadow:0 4px 14px rgba(0,0,0,.10);}
.srch-wrap input::placeholder{color:var(--text-soft);}
.srch-ic{position:absolute;left:15px;top:50%;transform:translateY(-50%);font-size:19px;opacity:.6;pointer-events:none;}

/* â”€â”€ SECTION HDR â”€â”€ */
.sec-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
.sec-hdr h2{font-size:16px;font-weight:900;color:var(--bark);font-family:'Heebo',sans-serif;}
.sec-count{font-size:12px;color:var(--text-soft);background:var(--parchment);padding:4px 12px;border-radius:14px;font-weight:700;border:1px solid var(--border);font-family:'Heebo',sans-serif;}

/* â”€â”€ VARIETY CARD â”€â”€ */
.vcard{
  background:white;
  border:2px solid var(--border);
  border-radius:var(--r);
  margin-bottom:16px;
  box-shadow:var(--shadow);
  overflow:hidden;
  transition:box-shadow .2s, transform .2s;
}
.vcard:active{transform:scale(.99);box-shadow:var(--shadow-lg);}

.vcard-photo{
  width:100%;height:200px;
  overflow:hidden;background:var(--parchment);
  display:flex;align-items:center;justify-content:center;
  font-size:72px;cursor:pointer;position:relative;
}
.vcard-photo img{width:100%;height:100%;object-fit:cover;}
.photo-count{
  position:absolute;bottom:12px;left:12px;
  background:rgba(30,20,10,.68);color:white;
  font-size:11px;font-weight:800;padding:5px 12px;border-radius:10px;
  backdrop-filter:blur(6px);box-shadow:0 2px 8px rgba(0,0,0,.2);
  font-family:'Heebo',sans-serif;
}
.photo-status{
  position:absolute;top:12px;right:12px;
  padding:6px 14px;border-radius:22px;
  font-size:11px;font-weight:900;
  backdrop-filter:blur(8px);
  box-shadow:0 3px 10px rgba(0,0,0,.22);
  font-family:'Heebo',sans-serif;
}
.ps-flowering{background:rgba(74,107,42,.88);color:white;}
.ps-seeding{background:rgba(180,120,10,.88);color:white;}
.ps-dormant{background:rgba(100,90,80,.78);color:white;}
.ps-selected{background:rgba(40,80,140,.88);color:white;}

.vcard-body{padding:16px 18px 14px;}
.vcard-name{font-size:17px;font-weight:900;color:var(--bark);margin-bottom:5px;line-height:1.3;font-family:'Heebo',sans-serif;}
.vcard-type{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap;}
.type-pill{display:inline-flex;align-items:center;gap:5px;padding:4px 12px;border-radius:14px;font-size:11px;font-weight:800;font-family:'Heebo',sans-serif;}
.tp-ran{background:#fde8d8;color:#8B3010;}
.tp-swe{background:#ead5f0;color:#5B2D80;}
.tp-cal{background:#fef5e0;color:#8B6000;}
.tp-oth{background:#e8f0d8;color:#3A5A10;}
.color-sw{width:18px;height:18px;border-radius:50%;border:2.5px solid rgba(0,0,0,.14);flex-shrink:0;box-shadow:0 2px 4px rgba(0,0,0,.08);}

.vcard-details{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;}
.vcd-item{background:var(--cream);border-radius:10px;padding:9px 12px;border:1px solid var(--border);}
.vcd-label{font-size:10px;font-weight:800;color:var(--text-soft);text-transform:uppercase;letter-spacing:.5px;font-family:'Heebo',sans-serif;}
.vcd-val{font-size:13px;font-weight:700;color:var(--text-mid);margin-top:3px;}

.stars{color:var(--amber);font-size:17px;letter-spacing:2px;}
.traits-row{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;}
.trait-tag{background:var(--parchment);color:var(--bark-mid);font-size:11px;font-weight:700;padding:4px 10px;border-radius:10px;border:1px solid var(--border);font-family:'Heebo',sans-serif;}

.vcard-actions{
  display:flex;gap:9px;padding:12px 16px 14px;
  border-top:2px solid var(--linen);
  background:linear-gradient(to bottom, var(--parchment) 0%, #F8F0E0 100%);
}
.cta{flex:1;padding:11px 8px;border:none;border-radius:11px;font-size:12px;font-weight:800;cursor:pointer;font-family:'Heebo',sans-serif;transition:transform .15s,box-shadow .15s;display:flex;align-items:center;justify-content:center;gap:4px;box-shadow:0 2px 6px rgba(0,0,0,.10);}
.cta:active{transform:scale(.96);}
.cta-bark{background:var(--bark);color:white;}
.cta-leaf{background:var(--leaf);color:white;}
.cta-sel{background:var(--sky);color:white;}
.cta-gold{background:var(--amber);color:white;}
.cta-moss{background:var(--moss);color:white;}
.cta-outline{background:white;color:var(--bark);border:2px solid var(--border);}

/* â”€â”€ EMPTY â”€â”€ */
.empty{text-align:center;padding:56px 22px;background:white;border-radius:var(--r);border:2px solid var(--border);box-shadow:var(--shadow);}
.empty-ic{font-size:60px;margin-bottom:18px;}
.empty h3{font-size:17px;font-weight:900;color:var(--bark);margin-bottom:9px;font-family:'Heebo',sans-serif;}
.empty p{font-size:14px;color:var(--text-soft);line-height:1.8;}

/* â”€â”€ FAB â”€â”€ */
.fab{position:fixed;bottom:92px;left:20px;width:64px;height:64px;border-radius:32px;background:linear-gradient(135deg, var(--rust) 0%, #D4750A 100%);color:white;font-size:34px;display:flex;align-items:center;justify-content:center;border:none;box-shadow:var(--shadow-lg);cursor:pointer;z-index:200;transition:transform .2s;}
.fab:active{transform:scale(.92);}

/* â”€â”€ BOTTOM NAV â”€â”€ */
.bnav{position:fixed;bottom:0;left:0;right:0;background:white;display:flex;border-top:2px solid var(--border);padding:9px 0 13px;z-index:100;box-shadow:0 -4px 18px rgba(0,0,0,.10);}
.bni{flex:1;text-align:center;cursor:pointer;color:var(--text-soft);transition:color .2s;}
.bni.on{color:var(--bark);}
.bni-ic{font-size:23px;}
.bni-lb{font-size:10px;font-weight:800;margin-top:3px;font-family:'Heebo',sans-serif;letter-spacing:.3px;}

/* â”€â”€ OVERLAY / SHEET â”€â”€ */
.overlay{display:none;position:fixed;inset:0;background:rgba(20,12,5,.54);z-index:500;align-items:flex-end;}
.overlay.on{display:flex;}
.sheet{background:var(--cream);border-radius:24px 24px 0 0;width:100%;max-height:95vh;overflow-y:auto;padding:22px 20px 40px;animation:up .3s ease;box-shadow:0 -10px 40px rgba(0,0,0,.3);}
@keyframes up{from{transform:translateY(100%)}to{transform:translateY(0)}}
.sh-handle{width:42px;height:5px;background:var(--border);border-radius:3px;margin:0 auto 22px;}
.sh-title{font-size:19px;font-weight:900;color:var(--bark);margin-bottom:22px;font-family:'Heebo',sans-serif;}

/* â”€â”€ FORM â”€â”€ */
.fg{margin-bottom:15px;}
.fl{display:block;font-size:11px;font-weight:800;color:var(--text-soft);margin-bottom:7px;text-transform:uppercase;letter-spacing:.6px;font-family:'Heebo',sans-serif;}
.fi,.fs,.ft{width:100%;padding:13px 15px;border:2px solid var(--border);border-radius:11px;font-size:15px;font-family:'Assistant',sans-serif;background:white;color:var(--text);font-weight:500;box-shadow:0 2px 6px rgba(0,0,0,.05);}
.fi:focus,.fs:focus,.ft:focus{outline:none;border-color:var(--clay);box-shadow:0 4px 12px rgba(0,0,0,.10);}
.ft{min-height:76px;resize:vertical;line-height:1.6;}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:13px;}

/* cam */
.cam-zone{border:2px dashed var(--border);border-radius:14px;padding:24px;text-align:center;cursor:pointer;background:var(--parchment);transition:border-color .2s,background .2s;}
.cam-zone:active{border-color:var(--clay);background:var(--linen);}
.cam-zone input{display:none;}
.cam-ic{font-size:44px;margin-bottom:4px;}
.cam-txt{font-size:13px;color:var(--text-soft);margin-top:9px;line-height:1.6;font-weight:600;}
.cam-btns{display:flex;gap:10px;margin-top:14px;justify-content:center;}
.cam-btn{padding:9px 18px;border:2px solid var(--border);border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;font-family:'Heebo',sans-serif;background:white;color:var(--bark-mid);transition:all .2s;box-shadow:0 2px 6px rgba(0,0,0,.06);}
.cam-btn:active{transform:scale(.96);}
.cam-btn input{display:none;}

.pgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;margin-top:12px;}
.pgi{aspect-ratio:1;border-radius:10px;overflow:hidden;position:relative;background:var(--parchment);border:2px solid var(--border);}
.pgi img{width:100%;height:100%;object-fit:cover;}
.pgdel{position:absolute;top:5px;right:5px;background:rgba(0,0,0,.62);color:white;border:none;border-radius:50%;width:24px;height:24px;font-size:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,.3);}

/* colors */
.crow{display:flex;flex-wrap:wrap;gap:11px;}
.csw{width:38px;height:38px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:transform .15s;box-shadow:0 2px 6px rgba(0,0,0,.10);}
.csw.on{border-color:var(--bark);transform:scale(1.2);box-shadow:0 4px 12px rgba(0,0,0,.20);}

/* rating */
.rrow{display:flex;gap:7px;font-size:36px;cursor:pointer;}
.rstar{color:var(--border);transition:color .15s;}.rstar.on{color:var(--amber);}

/* gps */
.gps-row{display:flex;justify-content:space-between;align-items:center;background:white;border:2px solid var(--border);border-radius:11px;padding:12px 15px;box-shadow:0 2px 6px rgba(0,0,0,.05);}
.gps-lbl strong{display:block;font-size:14px;color:var(--text);margin-bottom:3px;font-family:'Heebo',sans-serif;font-weight:800;}
.gps-lbl{font-size:12px;color:var(--text-soft);font-weight:600;}
.gps-acc{font-size:10px;margin-top:3px;font-weight:700;font-family:'Heebo',sans-serif;}
.gps-acc.good{color:var(--leaf);}.gps-acc.ok{color:var(--amber);}.gps-acc.bad{color:var(--rust);}
.gps-btn{background:var(--bark);color:white;border:none;border-radius:10px;padding:9px 14px;font-size:12px;font-weight:800;font-family:'Heebo',sans-serif;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.15);transition:transform .15s;}
.gps-btn:active{transform:scale(.96);}

.divider{height:2px;background:linear-gradient(to right, transparent, var(--border), transparent);margin:18px 0;border-radius:1px;}

/* modal actions */
.macts{display:flex;gap:11px;margin-top:22px;}
.mact{flex:1;padding:15px;border:none;border-radius:12px;font-size:15px;font-weight:900;cursor:pointer;font-family:'Heebo',sans-serif;box-shadow:0 3px 10px rgba(0,0,0,.12);transition:transform .15s;}
.mact:active{transform:scale(.97);}
.mact-save{background:linear-gradient(135deg, var(--bark) 0%, var(--bark-mid) 100%);color:white;flex:2;}
.mact-cancel{background:var(--parchment);color:var(--bark-mid);border:2px solid var(--border);}

/* â”€â”€ DETAIL â”€â”€ */
.det-hero{width:100%;height:240px;border-radius:var(--r);overflow:hidden;background:var(--parchment);display:flex;align-items:center;justify-content:center;font-size:88px;margin-bottom:18px;position:relative;cursor:pointer;border:2px solid var(--border);}
.det-hero img{width:100%;height:100%;object-fit:cover;}
.hero-dots{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);display:flex;gap:7px;}
.hdot{width:9px;height:9px;border-radius:50%;background:rgba(255,255,255,.5);box-shadow:0 1px 3px rgba(0,0,0,.2);}
.hdot.on{background:white;}
.det-name{font-size:19px;font-weight:900;color:var(--bark);font-family:'Heebo',sans-serif;}
.det-sub{font-size:13px;color:var(--text-soft);margin-top:4px;font-weight:600;}
.icard{background:white;border:2px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:13px;box-shadow:var(--shadow);}
.icard h3{font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:.6px;color:var(--text-soft);margin-bottom:11px;font-family:'Heebo',sans-serif;}
.irow{display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--linen);font-size:14px;}
.irow:last-child{border:none;}
.ikey{color:var(--text-soft);font-weight:600;}
.ival{font-weight:800;color:var(--text-mid);font-family:'Heebo',sans-serif;}
.map-btn{display:flex;align-items:center;gap:9px;background:#e8f0f8;border:2px solid #b8d0e8;border-radius:11px;padding:11px 15px;font-size:13px;color:var(--sky);font-weight:800;text-decoration:none;margin-bottom:13px;font-family:'Heebo',sans-serif;box-shadow:0 2px 6px rgba(0,0,0,.08);}
.tl-item{display:flex;gap:11px;padding:8px 0;font-size:13px;}
.tl-dot{width:9px;height:9px;border-radius:50%;background:var(--leaf-mid);margin-top:5px;flex-shrink:0;box-shadow:0 1px 3px rgba(0,0,0,.15);}
.tl-date{font-size:11px;color:var(--text-soft);margin-top:2px;font-weight:700;font-family:'Heebo',sans-serif;}

/* â”€â”€ FIELD VIEW â”€â”€ */
.loc-card{background:white;border:2px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:14px;box-shadow:var(--shadow);}
.loc-card h3{font-size:15px;font-weight:900;color:var(--bark);margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;font-family:'Heebo',sans-serif;}
.loc-item{display:flex;align-items:center;gap:11px;padding:9px 0;border-bottom:1px solid var(--linen);cursor:pointer;}
.loc-item:last-child{border:none;}
.loc-thumb{width:48px;height:48px;border-radius:10px;overflow:hidden;background:var(--parchment);display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;border:2px solid var(--border);}
.loc-thumb img{width:100%;height:100%;object-fit:cover;}

/* â”€â”€ SEASON â”€â”€ */
.sg{display:grid;grid-template-columns:repeat(2,1fr);gap:13px;margin-bottom:18px;}
.stile{background:white;border:2px solid var(--border);border-radius:var(--r);padding:17px;cursor:pointer;box-shadow:var(--shadow);transition:transform .2s;}
.stile:active{transform:scale(.98);}
.stile h4{font-size:14px;font-weight:900;color:var(--bark);margin-bottom:7px;font-family:'Heebo',sans-serif;}
.sbar{height:8px;border-radius:4px;background:var(--linen);margin-bottom:6px;box-shadow:inset 0 1px 2px rgba(0,0,0,.08);}
.sfill{height:100%;border-radius:4px;background:linear-gradient(90deg, var(--leaf) 0%, var(--leaf-mid) 100%);}

/* â”€â”€ TOAST â”€â”€ */
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-90px);background:var(--bark);color:white;padding:11px 22px;border-radius:22px;font-size:13px;font-weight:800;z-index:1000;transition:transform .25s;white-space:nowrap;box-shadow:var(--shadow-lg);font-family:'Heebo',sans-serif;}
.toast.on{transform:translateX(-50%) translateY(0);}

/* ---- View modes ---- */
.viewbar{display:flex;gap:8px;align-items:center;justify-content:flex-start;margin-top:10px}
.vbtn{border:1px solid rgba(0,0,0,.12);background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
.vbtn.active{background:#111;color:#fff;border-color:#111}
.vsp{width:1px;height:22px;background:rgba(0,0,0,.12);margin:0 2px}
#listEl.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(var(--gridMin,220px),1fr));gap:14px;align-items:stretch}
#listEl.grid .vcard{margin:0}
#listEl.grid .vcard-photo{height:190px}
#listEl.grid .vcard-body{padding:10px}
#listEl.grid .vcard-body > :not(.vcard-name){display:none}
#listEl.grid .vcard-name{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

</style>

<!-- Firebase (modular) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAKlv6rQhDia3fHAiAPjmGCuUdt1l0Zxdk",
  authDomain: "seed-management-5a24a.firebaseapp.com",
  projectId: "seed-management-5a24a",
  storageBucket: "seed-management-5a24a.firebasestorage.app",
  messagingSenderId: "483860268818",
  appId: "1:483860268818:web:b161f1dda473952d9815cb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

window.__fb = { auth, db, storage, signInAnonymously, onAuthStateChanged, doc, getDoc, setDoc, serverTimestamp, sRef, uploadBytes, getDownloadURL };
</script>

</head>
<body>

<div id="cloudPill" style="position:fixed;top:12px;left:12px;z-index:9999;display:flex;gap:8px;align-items:center;
  padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.92);border:1px solid rgba(0,0,0,.08);
  box-shadow:0 6px 20px rgba(0,0,0,.10);font-family:system-ui,-apple-system,Segoe UI,Roboto;direction:rtl">
  <span id="cloudDot" style="width:10px;height:10px;border-radius:50%;background:#999;display:inline-block"></span>
  <span id="cloudText" style="font-size:13px;color:#222">×¢× ×Ÿ: ××ª×—×‘×¨...</span>
  <button id="cloudSyncBtn" style="font-size:12px;border:0;border-radius:999px;padding:6px 10px;cursor:pointer;background:#111;color:#fff">Sync</button>
</div>


<div class="hdr">
  <div class="hdr-top">
    <div>
      <h1><span class="ic">ğŸŒ¿</span>××¢×§×‘ ×–× ×™× ××™×•×—×“×™×</h1>
      <div class="hdr-sub">×ª×™×¢×•×“ ×‘×©×˜×— Â· ×¦×™×œ×•× Â· GPS Â· ××¢×§×‘ ×¢×•× ×”</div>
    </div>
    <div class="hdr-btns">
      <button class="hbtn hbtn-exp" onclick="exportData()">ğŸ“¤</button>
      <button class="hbtn hbtn-add" onclick="openAdd()">ï¼‹ ×”×•×¡×£</button>
    </div>
  </div>
  <div class="stats">
    <div class="stt"><span class="stt-n" id="sTotal">0</span><span class="stt-l">×–× ×™×</span></div>
    <div class="stt"><span class="stt-n" id="sFlow">0</span><span class="stt-l">×¤×¨×™×—×”</span></div>
    <div class="stt"><span class="stt-n" id="sSel">0</span><span class="stt-l">× ×‘×—×¨×•</span></div>
    <div class="stt"><span class="stt-n" id="sSeed">0</span><span class="stt-l">×–×¨×¢×™×</span></div>
    <div class="stt"><span class="stt-n" id="sGps">0</span><span class="stt-l">GPS</span></div>
  </div>
</div>

<div class="fbar">
  <div class="fbar-inner">
    <span class="fbar-label">×¡×•×’:</span>
    <button class="fchip on" data-f="all" onclick="setF('all',this)">×”×›×œ ğŸŒ¿</button>
    <button class="fchip" data-f="ranunculus" onclick="setF('ranunculus',this)">× ×•×¨×™×•×ª ğŸŒº</button>
    <button class="fchip" data-f="sweetpea" onclick="setF('sweetpea',this)">Sweet Pea ğŸŒ¸</button>
    <button class="fchip" data-f="calendula" onclick="setF('calendula',this)">Calendula ğŸŒ¼</button>
    <button class="fchip" data-f="selected" onclick="setF('selected',this)">â­ × ×‘×—×¨×•</button>
    <button class="fchip" data-f="flowering" onclick="setF('flowering',this)">ğŸŸ¢ ×¤×¨×™×—×”</button>
  </div>
</div>

<div class="subtabs">
  <div class="stab on" data-v="list" onclick="sw('list')">ğŸ“‹ ×–× ×™×</div>
  <div class="stab" data-v="field" onclick="sw('field')">ğŸ—º ×©×“×”</div>
  <div class="stab" data-v="season" onclick="sw('season')">ğŸ“… ×¢×•× ×”</div>
</div>

<div class="content">
  <div id="view-list">
    <div class="srch-wrap"><span class="srch-ic">ğŸ”</span><input id="srch" type="text" placeholder="×—×™×¤×•×© ×©×, ××™×§×•×, ×××¤×™×™×Ÿ..." oninput="renderList()">

<div class="viewbar">
  <button class="vbtn" id="viewCards" title="×ª×¦×•×’×ª ×›×¨×˜×™×¡×™×">×›×¨×˜×™×¡×™×</button>
  <button class="vbtn" id="viewGrid" title="×ª×¦×•×’×ª ×œ×•×—×™×•×ª">×œ×•×—×™×•×ª</button>
  <div class="vsp"></div>
  <button class="vbtn" id="sizeS" title="×§×˜×Ÿ">S</button>
  <button class="vbtn" id="sizeM" title="×‘×™× ×•× ×™">M</button>
  <button class="vbtn" id="sizeL" title="×’×“×•×œ">L</button>
</div>
</div>
    <div class="sec-hdr"><h2>×–× ×™× ××ª×•×¢×“×™×</h2><span class="sec-count" id="cntLbl">0</span></div>
    <div id="listEl"></div>
  </div>
  <div id="view-field" style="display:none"><div class="sec-hdr"><h2>ğŸ—º ××¤×ª ×©×“×”</h2></div><div id="fieldEl"></div></div>
  <div id="view-season" style="display:none"><div class="sec-hdr"><h2>ğŸ“… ×¡×™×›×•× ×¢×•× ×”</h2><span class="sec-count" id="snLbl"></span></div><div id="seasonEl"></div></div>
</div>

<button class="fab" onclick="openAdd()">ï¼‹</button>

<div class="bnav">
  <div class="bni on" id="bn-list" onclick="sw('list')"><div class="bni-ic">ğŸ“‹</div><div class="bni-lb">×–× ×™×</div></div>
  <div class="bni" id="bn-field" onclick="sw('field')"><div class="bni-ic">ğŸ—º</div><div class="bni-lb">×©×“×”</div></div>
  <div class="bni" id="bn-season" onclick="sw('season')"><div class="bni-ic">ğŸ“…</div><div class="bni-lb">×¢×•× ×”</div></div>
</div>

<div class="toast" id="toast"></div>

<div class="overlay" id="addModal" onclick="bgc(event,'addModal')">
  <div class="sheet">
    <div class="sh-handle"></div>
    <div class="sh-title" id="mTitle">ğŸŒ± ×”×•×¡×¤×ª ×–×Ÿ ×—×“×©</div>

    <div class="fg">
      <label class="fl">ğŸ“· ×ª××•× ×•×ª</label>
      <div class="cam-zone">
        <div class="cam-ic">ğŸ“·</div>
        <div class="cam-txt">×”×•×¡×£ ×ª××•× ×•×ª ×œ×–×Ÿ</div>
        <div class="cam-btns">
          <label class="cam-btn">
            ğŸ“· ×¦×œ×
            <input type="file" accept="image/*" capture="environment" onchange="addPh(event)">
          </label>
          <label class="cam-btn">
            ğŸ–¼ ×’×œ×¨×™×”
            <input type="file" accept="image/*" multiple onchange="addPh(event)">
          </label>
        </div>
      </div>
      <div class="pgrid" id="pgrid"></div>
    </div>

    <div class="divider"></div>

    <div class="fg"><label class="fl">×©× ×”×–×Ÿ / ×§×•×“</label><input class="fi" id="fName" type="text" placeholder="× ×•×¨×™×” ×•×¨×•×“×” ×©×•×¨×” 4 / R-007"></div>

    <div class="grid2">
      <div class="fg"><label class="fl">×¡×•×’</label>
        <select class="fs" id="fType">
          <option value="ranunculus">× ×•×¨×™×•×ª ğŸŒº</option>
          <option value="sweetpea">Sweet Pea ğŸŒ¸</option>
          <option value="calendula">Calendula ğŸŒ¼</option>
          <option value="other">××—×¨ ğŸŒ¿</option>
        </select>
      </div>
      <div class="fg"><label class="fl">×¡×˜×˜×•×¡</label>
        <select class="fs" id="fStatus">
          <option value="flowering">ğŸŸ¢ ×‘×¤×¨×™×—×”</option>
          <option value="seeding">ğŸŸ¡ ×‘×–×¨×¢×™×</option>
          <option value="dormant">âšª ×¨×“×•×</option>
          <option value="selected">ğŸ”µ × ×‘×—×¨</option>
        </select>
      </div>
    </div>

    <div class="fg">
      <label class="fl">ğŸ“ ××™×§×•× GPS</label>
      <div class="gps-row">
        <div class="gps-lbl"><strong id="gpsLbl">×œ× × ×§×œ×˜</strong><div class="gps-acc" id="gpsAcc"></div></div>
        <button class="gps-btn" id="gpsBtn" onclick="grabGPS()">ğŸ“¡ ×§×œ×•×˜ GPS</button>
      </div>
      <input class="fi" id="fLoc" type="text" placeholder="×ª×™××•×¨ ×™×“× ×™: ×©×•×¨×” 4, ×¢××“×” 12..." style="margin-top:9px">
    </div>

    <div class="fg">
      <label class="fl">×¦×‘×¢ ×”×¤×¨×—</label>
      <div class="crow">
        <div class="csw on" style="background:#FF6B9D" data-c="#FF6B9D" onclick="pickC(this)"></div>
        <div class="csw" style="background:#E74C3C" data-c="#E74C3C" onclick="pickC(this)"></div>
        <div class="csw" style="background:#FF8C42" data-c="#FF8C42" onclick="pickC(this)"></div>
        <div class="csw" style="background:#FFD700" data-c="#FFD700" onclick="pickC(this)"></div>
        <div class="csw" style="background:#fff;border-color:#aaa" data-c="#FFFFFF" onclick="pickC(this)"></div>
        <div class="csw" style="background:#F5CBA7" data-c="#F5CBA7" onclick="pickC(this)"></div>
        <div class="csw" style="background:#D7BDE2" data-c="#D7BDE2" onclick="pickC(this)"></div>
        <div class="csw" style="background:#9B59B6" data-c="#9B59B6" onclick="pickC(this)"></div>
        <div class="csw" style="background:#C0392B" data-c="#C0392B" onclick="pickC(this)"></div>
        <div class="csw" style="background:#2ECC71" data-c="#2ECC71" onclick="pickC(this)"></div>
        <div class="csw" style="background:#1ABC9C" data-c="#1ABC9C" onclick="pickC(this)"></div>
        <div class="csw" style="background:#5D4037" data-c="#5D4037" onclick="pickC(this)"></div>
      </div>
    </div>

    <div class="fg"><label class="fl">×“×™×¨×•×’</label>
      <div class="rrow">
        <span class="rstar" data-r="1" onclick="pickR(1)">â˜…</span>
        <span class="rstar" data-r="2" onclick="pickR(2)">â˜…</span>
        <span class="rstar" data-r="3" onclick="pickR(3)">â˜…</span>
        <span class="rstar" data-r="4" onclick="pickR(4)">â˜…</span>
        <span class="rstar" data-r="5" onclick="pickR(5)">â˜…</span>
      </div>
    </div>

    <div class="fg"><label class="fl">×××¤×™×™× ×™× ××™×•×—×“×™×</label><input class="fi" id="fTraits" type="text" placeholder="×¨×™×— ×—×–×§, ×’×‘×¢×•×œ ××¨×•×š, ×¢××™×“ ×—×•×..."></div>
    <div class="fg"><label class="fl">×”×¢×¨×•×ª</label><textarea class="ft" id="fNotes" placeholder="×”×©×•×•××” ×œ×–× ×™× ××—×¨×™×, ×ª×¦×¤×™×•×ª..."></textarea></div>

    <div class="macts">
      <button class="mact mact-save" onclick="saveV()">ğŸŒ± ×©××™×¨×”</button>
      <button class="mact mact-cancel" onclick="closeM('addModal')">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<div class="overlay" id="detModal" onclick="bgc(event,'detModal')">
  <div class="sheet" id="detSheet"></div>
</div>

<script>

/* ---------- Photo storage (IndexedDB) ----------
   Stores images as Blobs to avoid localStorage quota issues.
   Records keep photo refs like: "idb:<key>".
*/
const PH_DB_NAME = 'variety_photos_v1';
const PH_STORE = 'photos';
const PH_CACHE = new Map(); // ref -> objectURL
let PH_DB_PROM = null;

function phOpen(){
  if(PH_DB_PROM) return PH_DB_PROM;
  PH_DB_PROM = new Promise((res, rej)=>{
    const req = indexedDB.open(PH_DB_NAME, 1);
    req.onupgradeneeded = () => {
      const db = req.result;
      if(!db.objectStoreNames.contains(PH_STORE)){
        db.createObjectStore(PH_STORE);
      }
    };
    req.onsuccess = ()=>res(req.result);
    req.onerror = ()=>rej(req.error);
  });
  return PH_DB_PROM;
}
async function phPut(blob){
  const db = await phOpen();
  const key = 'ph_' + Date.now() + '_' + Math.random().toString(16).slice(2);
  await new Promise((res, rej)=>{
    const tx = db.transaction(PH_STORE,'readwrite');
    tx.objectStore(PH_STORE).put(blob, key);
    tx.oncomplete = ()=>res(true);
    tx.onerror = ()=>rej(tx.error);
  });
  return 'idb:' + key;
}
async function phGet(ref){
  if(!ref || !ref.startsWith('idb:')) return null;
  const key = ref.slice(4);
  const db = await phOpen();
  return await new Promise((res, rej)=>{
    const tx = db.transaction(PH_STORE,'readonly');
    const req = tx.objectStore(PH_STORE).get(key);
    req.onsuccess = ()=>res(req.result||null);
    req.onerror = ()=>rej(req.error);
  });
}
async function phDel(ref){
  if(!ref || !ref.startsWith('idb:')) return;
  const key = ref.slice(4);
  const db = await phOpen();
  await new Promise((res, rej)=>{
    const tx = db.transaction(PH_STORE,'readwrite');
    tx.objectStore(PH_STORE).delete(key);
    tx.oncomplete = ()=>res(true);
    tx.onerror = ()=>rej(tx.error);
  });
  const url = PH_CACHE.get(ref);
  if(url){ try{ URL.revokeObjectURL(url); }catch(_){}
    PH_CACHE.delete(ref);
  }
}
function photoSrc(ref){
  if(!ref) return '';
  if(ref.startsWith('idb:')){
    return PH_CACHE.get(ref) || "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='800' height='500'><rect width='100%25' height='100%25' fill='%23f2ead8'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23666' font-size='24'>ğŸ“· ×˜×•×¢×Ÿ ×ª××•× ×”...</text></svg>";
  }
  return ref;
}
async function hydratePhotoRef(ref){
  if(!ref || !ref.startsWith('idb:')) return;
  if(PH_CACHE.has(ref)){
    document.querySelectorAll(`img[data-ph="${ref}"]`).forEach(img=>{ img.src = PH_CACHE.get(ref); });
    return;
  }
  const blob = await phGet(ref);
  if(!blob) return;
  const url = URL.createObjectURL(blob);
  PH_CACHE.set(ref, url);
  document.querySelectorAll(`img[data-ph="${ref}"]`).forEach(img=>{ img.src = url; });
}
async function hydrateAllPhotos(){
  const refs = new Set();
  document.querySelectorAll('img[data-ph]').forEach(img=>{
    const r = img.getAttribute('data-ph');
    if(r && r.startsWith('idb:')) refs.add(r);
  });
  for(const r of refs){
    try{ await hydratePhotoRef(r); }catch(_){}

async function migrateBase64Photos(){
  let changed = 0;
  for(const v of DB){
    if(!v || !Array.isArray(v.photos)) continue;
    for(let i=0;i<v.photos.length;i++){
      const p = v.photos[i];
      if(typeof p === 'string' && p.startsWith('data:image') && p.length > 2000){
        try{
          const blob = await (await fetch(p)).blob();
          const ref = await phPut(blob);
          v.photos[i] = ref;
          changed++;
        }catch(e){
          console.warn('photo migrate failed', e);
        }
      }
    }
  }
  if(changed){
    await saveDB();
  }
}

  }
}
async function compressImageToBlob(file, maxW=1400, quality=0.78){
  return await new Promise((res, rej)=>{
    const img = new Image();
    const url = URL.createObjectURL(file);
    img.onload = ()=>{
      try{
        let w = img.width, h = img.height;
        if(w > maxW){
          const s = maxW / w;
          w = Math.round(w*s); h = Math.round(h*s);
        }
        const c = document.createElement('canvas');
        c.width = w; c.height = h;
        const ctx = c.getContext('2d');
        ctx.drawImage(img,0,0,w,h);
        c.toBlob(b=>{
          try{ URL.revokeObjectURL(url); }catch(_){}
          if(!b) return rej(new Error('toBlob failed'));
          res(b);
        }, 'image/jpeg', quality);
      }catch(e){
        try{ URL.revokeObjectURL(url); }catch(_){}
        rej(e);
      }
    };
    img.onerror = (e)=>{ try{ URL.revokeObjectURL(url); }catch(_){}
      rej(e);
    };
    img.src = url;
  });
}


/* ---------- Storage shim ----------
   Provides window.storage.get/set on top of localStorage.
*/
if(!window.storage){
  window.storage = {
    async get(key){
      try{
        const v = localStorage.getItem(key);
        return v==null ? null : { value: v };
      }catch(e){ return null; }
    },
    async set(key, value){
      try{
        localStorage.setItem(key, value);
        return true;
      }catch(e){
        // keep message short; we'll fix photo storage separately
        try{ alert('××™×Ÿ ××¡×¤×™×§ ××§×•× ××—×¡×•×Ÿ ×‘××›×©×™×¨. ×‘×¦×¢ ×™×™×¦×•×/×’×™×‘×•×™ ××• ××—×§ × ×ª×•× ×™× ×™×©× ×™×.'); }catch(_){}
        return false;
      }
    }
  };
}

let DB=[],filt='all',editId=null,pC='#FF6B9D',pR=0,nPh=[],gpsC=null,dIdx=0;
const TL={ranunculus:'× ×•×¨×™×•×ª',sweetpea:'Sweet Pea',calendula:'Calendula',other:'××—×¨'};
const TE={ranunculus:'ğŸŒº',sweetpea:'ğŸŒ¸',calendula:'ğŸŒ¼',other:'ğŸŒ¿'};
const SL={flowering:'×‘×¤×¨×™×—×”',seeding:'×‘×–×¨×¢×™×',dormant:'×¨×“×•×',selected:'× ×‘×—×¨'};
const SE={flowering:'ğŸŸ¢',seeding:'ğŸŸ¡',dormant:'âšª',selected:'ğŸ”µ'};
const TC={ranunculus:'tp-ran',sweetpea:'tp-swe',calendula:'tp-cal',other:'tp-oth'};
const PSB={flowering:'ps-flowering',seeding:'ps-seeding',dormant:'ps-dormant',selected:'ps-selected'};

async function load(){try{const r=await window.storage.get('vdb_v6');if(r?.value)DB=JSON.parse(r.value);}catch(e){DB=[];}}
async function save(){try{await window.storage.set('vdb_v6',JSON.stringify(DB));}catch(e){}}
async function saveDB(){ await save(); }

async function boot(){
  await load();
  if(!DB.length)DB=[
    {id:1001,name:'× ×•×¨×™×” ×•×¨×•×“×” ×¢××•×§×” â€” ×©×•×¨×” 4',type:'ranunculus',color:'#FF6B9D',locText:'×©×•×¨×” 4, ×¢××“×” 7',gps:null,status:'selected',rating:5,traits:'×¢×œ×™ ×›×•×ª×¨×ª ×›×¤×•×œ×™×, ×¨×™×— ×¢×–, ×’×‘×¢×•×œ 60cm',notes:'×¦×‘×¢ ×™×™×—×•×“×™, ×©××•×¨ ×œ×¤×§×¢×ª.',photos:[],created:today(),updated:today(),season:getSeason(),log:[{d:today(),n:'×ª×•×¢×“ ğŸŒ±'},{d:today(),n:'â­ × ×‘×—×¨'}]},
    {id:1002,name:'Sweet Pea ×œ×‘×Ÿ ×¨×™×—× ×™ â€” ×’×•×© B',type:'sweetpea',color:'#FFFFFF',locText:'×’×•×© B, ×©×•×¨×” 2',gps:null,status:'seeding',rating:4,traits:'×¨×™×— ××™×•×—×“, ×’×‘×¢×•×œ ××¨×•×š',notes:'×”×¨×™×—× ×™ ×‘×™×•×ª×¨ ×”×©× ×”.',photos:[],created:today(),updated:today(),season:getSeason(),log:[{d:today(),n:'×ª×•×¢×“ ğŸŒ±'}]}
  ];
  await saveDB();
  document.getElementById('snLbl').textContent='×¢×•× ×” '+getSeason();
  renderAll();
}

function renderAll(){updateStats();renderList();renderField();renderSeason();}

function updateStats(){
  document.getElementById('sTotal').textContent=DB.length;
  document.getElementById('sFlow').textContent=DB.filter(v=>v.status==='flowering').length;
  document.getElementById('sSel').textContent=DB.filter(v=>v.status==='selected').length;
  document.getElementById('sSeed').textContent=DB.filter(v=>v.status==='seeding').length;
  document.getElementById('sGps').textContent=DB.filter(v=>v.gps).length;
  hydrateAllPhotos();
}

function getFilt(){
  const q=document.getElementById('srch').value.toLowerCase();
  return DB.filter(v=>{
    const mf=filt==='all'?true:filt==='selected'?v.status==='selected':filt==='flowering'?v.status==='flowering':v.type===filt;
    const ms=!q||v.name.toLowerCase().includes(q)||(v.traits||'').toLowerCase().includes(q)||(v.locText||'').toLowerCase().includes(q);
    return mf&&ms;
  });
}

function renderList(){
  const el=document.getElementById('listEl'),data=getFilt();
  document.getElementById('cntLbl').textContent=data.length+' ×–× ×™×';
  if(!data.length){el.innerHTML=`<div class="empty"><div class="empty-ic">${DB.length?'ğŸ”':'ğŸŒ±'}</div><h3>${DB.length?'×œ× × ××¦××•':'××™×Ÿ ×–× ×™× ×¢×“×™×™×Ÿ'}</h3><p>${DB.length?'× ×¡×” ×¡×™× ×•×Ÿ ××—×¨':'×œ×—×¥ "+ ×”×•×¡×£" ×œ×”×ª×—×œ×”'}</p></div>`;return;}
  el.innerHTML=data.map(v=>{
    const bgCol=v.color&&v.color!=='#FFFFFF'?v.color+'33':'#F2EAD8';
    const photoHtml=v.photos?.length
      ?`<div class="vcard-photo" onclick="openDet(${v.id})"><img data-ph="${v.photos[0]}" src="${photoSrc(v.photos[0])}">${v.photos.length>1?`<div class="photo-count">ğŸ“· ${v.photos.length}</div>`:''}<div class="photo-status ${PSB[v.status]}">${SE[v.status]} ${SL[v.status]}</div></div>`
      :`<div class="vcard-photo" style="background:${bgCol}" onclick="openDet(${v.id})"><span style="font-size:60px">${TE[v.type]}</span><div class="photo-status ${PSB[v.status]}">${SE[v.status]} ${SL[v.status]}</div></div>`;
    const stars='â˜…'.repeat(v.rating||0)+'â˜†'.repeat(5-(v.rating||0));
    const loc=v.gps?`ğŸ“¡ ${v.locText||cs(v.gps)}`:v.locText?`ğŸ“ ${v.locText}`:'ğŸ“ ×œ×œ× ××™×§×•×';
    const traitTags=(v.traits||'').split(',').filter(Boolean).slice(0,3).map(t=>`<span class="trait-tag">${t.trim()}</span>`).join('');
    return `
    <div class="vcard">
      ${photoHtml}
      <div class="vcard-body">
        <div class="vcard-name">${v.name}</div>
        <div class="vcard-type">
          <span class="type-pill ${TC[v.type]}">${TE[v.type]} ${TL[v.type]}</span>
          <span class="color-sw" style="background:${v.color||'#ccc'}"></span>
          <span class="stars" style="font-size:15px">${stars}</span>
        </div>
        <div class="vcard-details">
          <div class="vcd-item"><div class="vcd-label">××™×§×•×</div><div class="vcd-val" style="font-size:12px">${loc}</div></div>
          <div class="vcd-item"><div class="vcd-label">×¢×“×›×•×Ÿ</div><div class="vcd-val" style="font-size:12px">${v.updated}</div></div>
        </div>
        ${traitTags?`<div class="traits-row">${traitTags}</div>`:''}
      </div>
      <div class="vcard-actions">
        <button class="cta cta-outline" onclick="openDet(${v.id})">ğŸ“‹ ×¤×¨×˜×™×</button>
        <button class="cta cta-bark" onclick="openEdit(${v.id})">âœï¸ ×¢×¨×™×›×”</button>
        <button class="cta ${v.status==='selected'?'cta-gold':'cta-sel'}" onclick="togSel(${v.id})">${v.status==='selected'?'âœ…':'â­'}</button>
        <button class="cta cta-moss" onclick="qNote(${v.id})">ğŸ“</button>
      </div>
    </div>`;
  }).join('');
applyViewUI();
}

function renderField(){
  const el=document.getElementById('fieldEl');
  if(!DB.length){el.innerHTML='<div class="empty"><div class="empty-ic">ğŸ—º</div><h3>××™×Ÿ ×–× ×™×</h3></div>';return;}
  const byL={};DB.forEach(v=>{const k=v.locText||(v.gps?cs(v.gps):'×œ×œ× ××™×§×•×');if(!byL[k])byL[k]=[];byL[k].push(v);});
  el.innerHTML=Object.entries(byL).map(([loc,vs])=>`
    <div class="loc-card">
      <h3><span>ğŸ“ ${loc}</span>${vs[0]?.gps?`<a href="https://maps.google.com/?q=${vs[0].gps.lat},${vs[0].gps.lng}" target="_blank" style="font-size:12px;color:var(--sky);font-weight:700;text-decoration:none">ğŸ—º ××¤×”</a>`:''}
      </h3>
      ${vs.map(v=>`<div class="loc-item" onclick="openDet(${v.id})">
        <div class="loc-thumb">${v.photos?.length?`<img data-ph="${v.photos[0]}" src="${photoSrc(v.photos[0])}">`:`${TE[v.type]}`}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:14px;font-weight:800;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--bark)">${v.name}</div>
          <div style="font-size:11px;color:var(--text-soft);margin-top:2px">${SE[v.status]} ${SL[v.status]} Â· ${'â˜…'.repeat(v.rating||0)}</div>
        </div>
      </div>`).join('')}
    </div>`).join('');
}

function renderSeason(){
  const el=document.getElementById('seasonEl');
  const types=['ranunculus','sweetpea','calendula'].filter(t=>DB.some(v=>v.type===t));
  if(!types.length){el.innerHTML='<div class="empty"><div class="empty-ic">ğŸ“…</div><h3>××™×Ÿ × ×ª×•× ×™×</h3></div>';return;}
  el.innerHTML=`<div class="sg">${types.map(t=>{
    const arr=DB.filter(v=>v.type===t),sel=arr.filter(v=>v.status==='selected').length,pct=Math.round(sel/arr.length*100);
    return `<div class="stile" onclick="setF('${t}',null);sw('list')">
      <h4>${TE[t]} ${TL[t]}</h4>
      <div style="font-size:30px;font-weight:900;color:var(--bark)">${arr.length}</div>
      <div style="font-size:11px;color:var(--text-soft);margin-bottom:9px">×–× ×™×</div>
      <div class="sbar"><div class="sfill" style="width:${pct}%"></div></div>
      <div style="font-size:10px;color:var(--text-soft);font-weight:700">${sel} × ×‘×—×¨×• Â· ${pct}%</div>
    </div>`;}).join('')}</div>
  <div class="icard"><h3>ğŸ“Š ×¡×™×›×•× ×¢×•× ×”</h3>
  ${[['×¡×”×´×› ×–× ×™×',DB.length],['× ×‘×—×¨×• ×œ×©××™×¨×”',DB.filter(v=>v.status==='selected').length],['×‘×¤×¨×™×—×”',DB.filter(v=>v.status==='flowering').length],['×‘×”×™×¦×¨×•×ª ×–×¨×¢×™×',DB.filter(v=>v.status==='seeding').length],['×¢× GPS',DB.filter(v=>v.gps).length],['×¢× ×ª××•× ×•×ª',DB.filter(v=>v.photos?.length).length],['×“×™×¨×•×’ ×××•×¦×¢',DB.length?(DB.reduce((a,v)=>a+(v.rating||0),0)/DB.length).toFixed(1)+' â˜…':'â€”']].map(([k,v])=>`<div class="irow"><span class="ikey">${k}</span><span class="ival">${v}</span></div>`).join('')}</div>`;
}

function openDet(id){
  const v=DB.find(v=>v.id===id);hydrateAllPhotos();
if(!v)return;dIdx=0;
  const stars='â˜…'.repeat(v.rating||0)+'â˜†'.repeat(5-(v.rating||0));
  const bgCol=v.color&&v.color!=='#FFFFFF'?v.color+'33':'#F2EAD8';
  const hero=v.photos?.length
    ?`<div class="det-hero" onclick="nHero(${id})" id="hero-${id}"><img data-ph="${v.photos[0]}" src="${photoSrc(v.photos[0])}" id="hi-${id}">${v.photos.length>1?`<div class="hero-dots">${v.photos.map((_,i)=>`<div class="hdot${i===0?' on':''}"></div>`).join('')}</div>`:''}</div>`
    :`<div class="det-hero" style="background:${bgCol}">${TE[v.type]}</div>`;
  const log=(v.log||[]).slice().reverse().map(l=>`<div class="tl-item"><div class="tl-dot"></div><div><div>${l.n}</div><div class="tl-date">${l.d}</div></div></div>`).join('');
  const mapsHtml=v.gps?`<a class="map-btn" href="https://maps.google.com/?q=${v.gps.lat},${v.gps.lng}" target="_blank">ğŸ—º ×¤×ª×— ×‘-Google Maps <span style="font-weight:500;font-size:11px">(${cs(v.gps)})</span></a>`:'';
  document.getElementById('detSheet').innerHTML=`
    <div class="sh-handle"></div>${hero}
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px">
      <div><div class="det-name">${v.name}</div><div class="det-sub">${TE[v.type]} ${TL[v.type]}</div>
      <div class="stars" style="font-size:21px;margin-top:5px">${stars}</div></div>
      <span style="background:var(--parchment);border:2px solid var(--border);border-radius:14px;padding:6px 13px;font-size:12px;font-weight:900;color:var(--bark-mid);font-family:'Heebo',sans-serif">${SE[v.status]} ${SL[v.status]}</span>
    </div>
    ${mapsHtml}
    <div class="icard"><h3>×¤×¨×˜×™×</h3>
      <div class="irow"><span class="ikey">××™×§×•×</span><span class="ival">${v.locText||'â€”'}</span></div>
      <div class="irow"><span class="ikey">×¦×‘×¢</span><span class="ival"><span style="display:inline-block;width:14px;height:14px;border-radius:50%;background:${v.color||'#ccc'};border:2px solid #ddd;vertical-align:middle;margin-left:5px"></span>${v.color||'â€”'}</span></div>
      <div class="irow"><span class="ikey">×¢×•× ×”</span><span class="ival">${v.season||'â€”'}</span></div>
      <div class="irow"><span class="ikey">×¢×•×“×›×Ÿ</span><span class="ival">${v.updated}</span></div>
      <div class="irow"><span class="ikey">×ª××•× ×•×ª</span><span class="ival">${v.photos?.length||0} ğŸ“·</span></div>
    </div>
    ${v.traits?`<div class="icard"><h3>×××¤×™×™× ×™×</h3><div class="traits-row">${v.traits.split(',').map(t=>`<span class="trait-tag">${t.trim()}</span>`).join('')}</div></div>`:''}
    ${v.notes?`<div class="icard"><h3>×”×¢×¨×•×ª</h3><div style="font-size:14px;line-height:1.8;color:var(--text-mid)">${v.notes}</div></div>`:''}
    ${log?`<div class="icard"><h3>×”×™×¡×˜×•×¨×™×”</h3>${log}</div>`:''}
    <div style="display:flex;gap:12px;margin-top:18px">
      <button class="mact mact-save" onclick="openEdit(${id});closeM('detModal')" style="flex:2">âœï¸ ×¢×¨×™×›×”</button>
      <button class="mact" style="background:#fde8d8;color:var(--rust);border:none" onclick="delV(${id});closeM('detModal')">ğŸ—‘</button>
      <button class="mact mact-cancel" onclick="closeM('detModal')">×¡×’×•×¨</button>
    </div>`;
  document.getElementById('detModal').classList.add('on');
}

function nHero(id){const v=DB.find(v=>v.id===id);if(!v?.photos||v.photos.length<2)return;dIdx=(dIdx+1)%v.photos.length;const ref=v.photos[dIdx]; const img=document.getElementById(`hi-${id}`); img.setAttribute('data-ph', ref); img.src=photoSrc(ref); hydratePhotoRef(ref);document.querySelectorAll(`#hero-${id} .hdot`).forEach((d,i)=>d.classList.toggle('on',i===dIdx));}

function openAdd(){editId=null;pC='#FF6B9D';pR=0;nPh=[];gpsC=null;document.getElementById('mTitle').textContent='ğŸŒ± ×”×•×¡×¤×ª ×–×Ÿ ×—×“×©';['fName','fLoc','fTraits','fNotes'].forEach(id=>document.getElementById(id).value='');document.getElementById('fType').value='ranunculus';document.getElementById('fStatus').value='flowering';resetUI();document.getElementById('addModal').classList.add('on');}
function openEdit(id){const v=DB.find(v=>v.id===id);if(!v)return;editId=id;pC=v.color||'#FF6B9D';pR=v.rating||0;nPh=v.photos?[...v.photos]:[];gpsC=v.gps||null;document.getElementById('mTitle').textContent='âœï¸ ×¢×¨×™×›×ª ×–×Ÿ';document.getElementById('fName').value=v.name;document.getElementById('fType').value=v.type;document.getElementById('fLoc').value=v.locText||'';document.getElementById('fStatus').value=v.status;document.getElementById('fTraits').value=v.traits||'';document.getElementById('fNotes').value=v.notes||'';resetUI();document.querySelector(`[data-c="${pC}"]`)?.classList.add('on');pickR(pR);renderPG();updateGUI();document.getElementById('addModal').classList.add('on');}

function resetUI(){document.querySelectorAll('.csw').forEach(s=>s.classList.remove('on'));document.querySelector(`[data-c="${pC}"]`)?.classList.add('on');document.querySelectorAll('.rstar').forEach(s=>s.classList.remove('on'));document.getElementById('pgrid').innerHTML='';document.getElementById('gpsLbl').textContent='×œ× × ×§×œ×˜';document.getElementById('gpsAcc').textContent='';document.getElementById('gpsAcc').className='gps-acc';}
function updateGUI(){if(gpsC){document.getElementById('gpsLbl').textContent=cs(gpsC);document.getElementById('gpsAcc').className='gps-acc good';document.getElementById('gpsAcc').textContent=`âœ… ×“×™×•×§: ${gpsC.acc||'?'}××³`;}else{document.getElementById('gpsLbl').textContent='×œ× × ×§×œ×˜';document.getElementById('gpsAcc').textContent='';}}
function pickC(el){document.querySelectorAll('.csw').forEach(s=>s.classList.remove('on'));el.classList.add('on');pC=el.dataset.c;}
function pickR(v){pR=v;document.querySelectorAll('.rstar').forEach(s=>s.classList.toggle('on',parseInt(s.dataset.r)<=v));}
async function addPh(e){
  const files = Array.from(e.target.files||[]).slice(0, 5-nPh.length);
  for(const f of files){
    try{
      const blob = await compressImageToBlob(f, 1400, 0.78);
      const ref = await phPut(blob);
      nPh.push(ref);
    }catch(err){
      console.warn(err);
      alert('×œ× ×”×¦×œ×—×ª×™ ×œ×©××•×¨ ×ª××•× ×”. × ×¡×” ×ª××•× ×” ××—×¨×ª.');
    }
  }
  renderPG();
}
function renderPG(){
  document.getElementById('pgrid').innerHTML = nPh.map((p,i)=>`<div class="pgi"><img data-ph="${p}" src="${photoSrc(p)}"><button class="pgdel" onclick="rmPh(${i})">âœ•</button></div>`).join('');
  hydrateAllPhotos();
}
async function rmPh(i){
  const ref = nPh[i];
  nPh.splice(i,1);
  try{ await phDel(ref); }catch(_){}
  renderPG();
}
function grabGPS(){
  const btn=document.getElementById('gpsBtn');
  btn.textContent='â³ ××—×¤×©...';
  document.getElementById('gpsAcc').className='gps-acc ok';
  document.getElementById('gpsAcc').textContent='××—×¤×© ××™×ª×•×ª GPS...';
  
  if(!navigator.geolocation){
    showToast('âš ï¸ GPS ×œ× × ×ª××š ×‘×“×¤×“×¤×Ÿ');
    btn.textContent='ğŸ“¡ ×§×œ×•×˜ GPS';
    return;
  }
  
  navigator.geolocation.getCurrentPosition(
    pos=>{
      gpsC={lat:pos.coords.latitude.toFixed(6),lng:pos.coords.longitude.toFixed(6),acc:Math.round(pos.coords.accuracy)};
      updateGUI();
      btn.textContent='ğŸ“¡ ×§×œ×•×˜ ×©×•×‘';
      showToast('ğŸ“ GPS × ×§×œ×˜ ×‘×”×¦×œ×—×”!');
    },
    err=>{
      document.getElementById('gpsAcc').className='gps-acc bad';
      if(err.code===1){
        document.getElementById('gpsAcc').textContent='âŒ × ×“×¨×©×ª ×”×¨×©××” â€” ×¤×ª×— ×”×’×“×¨×•×ª';
      }else if(err.code===2){
        document.getElementById('gpsAcc').textContent='âŒ ××™×§×•× ×œ× ×–××™×Ÿ';
      }else{
        document.getElementById('gpsAcc').textContent='âŒ ×¤×¡×§ ×–××Ÿ â€” × ×¡×” ×©×•×‘';
      }
      btn.textContent='ğŸ“¡ × ×¡×” ×©×•×‘';
      showToast('âš ï¸ ×œ× ×”×¦×œ×—×ª×™ ×œ×§×œ×•×˜ GPS');
    },
    {enableHighAccuracy:true,timeout:15000,maximumAge:0}
  );
}

async function saveV(){const name=document.getElementById('fName').value.trim();if(!name){showToast('âš ï¸ ×—×¡×¨ ×©×');return;}const now=today();if(editId){const idx=DB.findIndex(v=>v.id===editId);if(idx>=0){const old=DB[idx],ns=document.getElementById('fStatus').value;DB[idx]={...old,name,type:document.getElementById('fType').value,color:pC,locText:document.getElementById('fLoc').value.trim(),gps:gpsC,status:ns,rating:pR,traits:document.getElementById('fTraits').value.trim(),notes:document.getElementById('fNotes').value.trim(),photos:nPh,updated:now};if(old.status!==ns){DB[idx].log=DB[idx].log||[];DB[idx].log.push({d:now,n:`×¡×˜×˜×•×¡ â†’ ${SL[ns]}`});}if(gpsC&&!old.gps){DB[idx].log=DB[idx].log||[];DB[idx].log.push({d:now,n:`ğŸ“ GPS: ${cs(gpsC)}`});}}showToast('âœ… ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”');}else{DB.unshift({id:Date.now(),name,type:document.getElementById('fType').value,color:pC,locText:document.getElementById('fLoc').value.trim(),gps:gpsC,status:document.getElementById('fStatus').value,rating:pR,traits:document.getElementById('fTraits').value.trim(),notes:document.getElementById('fNotes').value.trim(),photos:nPh,created:now,updated:now,season:getSeason(),log:[{d:now,n:'×ª×•×¢×“ ğŸŒ±'},...(gpsC?[{d:now,n:`ğŸ“ GPS: ${cs(gpsC)}`}]:[])]});showToast('âœ… ×–×Ÿ ×—×“×© × ×•×¡×£!');}await save();closeM('addModal');renderAll();}
async function togSel(id){const v=DB.find(v=>v.id===id);if(!v)return;const was=v.status==='selected';v.status=was?'flowering':'selected';v.updated=today();v.log=v.log||[];v.log.push({d:today(),n:was?'×”×•×¡×¨ ×× ×‘×—×¨×™×':'â­ × ×‘×—×¨ ×œ×©××™×¨×”'});await save();renderAll();showToast(was?'â†©ï¸ ×”×•×¡×¨ ×× ×‘×—×¨×™×':'â­ × ×‘×—×¨ ×œ×©××™×¨×”!');}
async function delV(id){if(!confirm('×œ××—×•×§ ×–×Ÿ ×–×”?'))return;DB=DB.filter(v=>v.id!==id);await save();renderAll();showToast('ğŸ—‘ × ××—×§');}
async function qNote(id){const note=prompt('×”×¢×¨×” ××”×™×¨×”:');if(!note?.trim())return;const v=DB.find(v=>v.id===id);if(!v)return;v.log=v.log||[];v.log.push({d:today(),n:note.trim()});v.updated=today();await save();renderAll();showToast('ğŸ“ ×”×¢×¨×” × ×©××¨×”');}

function setF(f,btn){filt=f;document.querySelectorAll('.fchip[data-f]').forEach(c=>c.classList.remove('on'));if(btn)btn.classList.add('on');else document.querySelector(`.fchip[data-f="${f}"]`)?.classList.add('on');renderList();}
function sw(tab){['list','field','season'].forEach(t=>{document.getElementById(`view-${t}`).style.display=t===tab?'block':'none';});document.querySelectorAll('[data-v]').forEach(el=>el.classList.toggle('on',el.dataset.v===tab));document.querySelectorAll('.bni').forEach(n=>n.classList.remove('on'));document.getElementById(`bn-${tab}`)?.classList.add('on');}
function closeM(id){document.getElementById(id).classList.remove('on');}
function bgc(e,id){if(e.target===document.getElementById(id))closeM(id);}
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('on');setTimeout(()=>t.classList.remove('on'),2400);}
function exportData(){const b=new Blob([JSON.stringify(DB,null,2)],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=`varieties_${today()}.json`;a.click();showToast('ğŸ“¤ ×§×•×‘×¥ ×™×•×¦×');}
function today(){return new Date().toISOString().split('T')[0];}
function getSeason(){const n=new Date(),y=n.getFullYear(),m=n.getMonth()+1;return m>=9?`${y}-${y+1}`:`${y-1}-${y}`;}
function cs(g){return g?`${g.lat}, ${g.lng}`:''}

boot();



/* ---- View mode state ---- */
let VIEW_MODE = (localStorage.getItem('viewMode')||'cards'); // cards | grid
let GRID_SIZE = (localStorage.getItem('gridSize')||'M'); // S|M|L
function applyViewUI(){
  const el=document.getElementById('listEl');
  if(el) el.classList.toggle('grid', VIEW_MODE==='grid');
  const root=document.documentElement;
  const map={S:160,M:220,L:300};
  root.style.setProperty('--gridMin', (map[GRID_SIZE]||220)+'px');
  const setActive=(id,on)=>{const b=document.getElementById(id); if(b) b.classList.toggle('active',!!on);};
  setActive('viewCards', VIEW_MODE==='cards');
  setActive('viewGrid', VIEW_MODE==='grid');
  setActive('sizeS', GRID_SIZE==='S');
  setActive('sizeM', GRID_SIZE==='M');
  setActive('sizeL', GRID_SIZE==='L');
}
function setView(mode){ VIEW_MODE=mode; localStorage.setItem('viewMode',mode); renderList(); applyViewUI(); }
function setGridSize(sz){ GRID_SIZE=sz; localStorage.setItem('gridSize',sz); applyViewUI(); }

window.addEventListener('load', ()=>{
  const vc=document.getElementById('viewCards'); if(vc) vc.onclick=()=>setView('cards');
  const vg=document.getElementById('viewGrid'); if(vg) vg.onclick=()=>setView('grid');
  const sS=document.getElementById('sizeS'); if(sS) sS.onclick=()=>setGridSize('S');
  const sM=document.getElementById('sizeM'); if(sM) sM.onclick=()=>setGridSize('M');
  const sL=document.getElementById('sizeL'); if(sL) sL.onclick=()=>setGridSize('L');
  applyViewUI();
});


/* ---------- Cloud Backup (Firebase) ---------- */
let CLOUD = { uid:null, ready:false, pushTimer:null, pushing:false, pulling:false, enabled:true };

function cloudUI(state,msg){
  const dot=document.getElementById('cloudDot'); const text=document.getElementById('cloudText');
  if(!dot||!text) return;
  dot.style.background = state==='ok' ? '#16a34a' : state==='busy' ? '#f59e0b' : state==='err' ? '#dc2626' : '#999';
  text.textContent = msg||'';
}
function cloudToast(msg){ try{ toast(msg);}catch(_){ try{alert(msg)}catch(__){} } }

async function cloudInit(){
  if(!window.__fb){ cloudUI('err','×¢× ×Ÿ: Firebase ×œ× × ×˜×¢×Ÿ'); return; }
  const { auth, signInAnonymously, onAuthStateChanged } = window.__fb;
  try{
    cloudUI('busy','×¢× ×Ÿ: ××ª×—×‘×¨...');
    await signInAnonymously(auth);
    onAuthStateChanged(auth,(u)=>{
      if(u){
        CLOUD.uid=u.uid; CLOUD.ready=true;
        cloudUI('ok','×¢× ×Ÿ: ××—×•×‘×¨');
        cloudPullIfNewer().catch(()=>{});
      }
    });
  }catch(e){
    console.warn(e); cloudUI('err','×¢× ×Ÿ: ×©×’×™××ª ×”×ª×—×‘×¨×•×ª');
  }
}
function cloudDocRef(){
  const { db, doc } = window.__fb;
  return doc(db,'users',CLOUD.uid,'apps','variety-tracker','state');
}
function cloudMetaKey(){ return 'cloud_meta_v1'; }
function cloudGetMeta(){ try{return JSON.parse(localStorage.getItem(cloudMetaKey())||'{}')}catch(_){return {}} }
function cloudSetMeta(m){ try{localStorage.setItem(cloudMetaKey(),JSON.stringify(m||{}))}catch(_){} }

async function uploadPhotoRef(refStr){
  try{
    if(!refStr) return refStr;
    if(refStr.startsWith('http://')||refStr.startsWith('https://')) return refStr;
    if(!refStr.startsWith('idb:')) return refStr;
    const blob = await phGet(refStr);
    if(!blob) return refStr;
    const { storage, sRef, uploadBytes, getDownloadURL } = window.__fb;
    const path = `users/${CLOUD.uid}/variety-tracker/photos/${refStr.slice(4)}.jpg`;
    const r = sRef(storage, path);
    await uploadBytes(r, blob, { contentType:'image/jpeg' });
    return await getDownloadURL(r);
  }catch(e){ console.warn('upload photo failed', e); return refStr; }
}
async function cloudPackDB(){
  const copy = JSON.parse(JSON.stringify(DB||[]));
  for(const v of copy){
    if(v && Array.isArray(v.photos)){
      for(let i=0;i<v.photos.length;i++){
        v.photos[i] = await uploadPhotoRef(v.photos[i]);
      }
    }
  }
  return copy;
}
function cloudSchedulePush(){
  if(!CLOUD.enabled) return;
  if(CLOUD.pushTimer) clearTimeout(CLOUD.pushTimer);
  CLOUD.pushTimer = setTimeout(()=>cloudPush().catch(()=>{}), 2500);
}
async function cloudPush(){
  if(!CLOUD.ready || CLOUD.pushing || !CLOUD.enabled) return;
  CLOUD.pushing=true; cloudUI('busy','×¢× ×Ÿ: ××’×‘×”...');
  try{
    const { setDoc, serverTimestamp } = window.__fb;
    const data = await cloudPackDB();
    await setDoc(cloudDocRef(), { updatedAt: serverTimestamp(), schema:'v1', data }, { merge:true });
    const meta = cloudGetMeta(); meta.lastPush = Date.now(); cloudSetMeta(meta);
    cloudUI('ok','×¢× ×Ÿ: ×’×™×‘×•×™ ×¢×•×“×›×Ÿ');
  }catch(e){ console.warn(e); cloudUI('err','×¢× ×Ÿ: ×’×™×‘×•×™ × ×›×©×œ'); }
  finally{ CLOUD.pushing=false; }
}
async function cloudPullIfNewer(){
  if(!CLOUD.ready || CLOUD.pulling || !CLOUD.enabled) return;
  CLOUD.pulling=true; cloudUI('busy','×¢× ×Ÿ: ×‘×•×“×§ ×¢×“×›×•×Ÿ...');
  try{
    const { getDoc } = window.__fb;
    const snap = await getDoc(cloudDocRef());
    if(!snap.exists()){ cloudUI('ok','×¢× ×Ÿ: ××—×•×‘×¨'); return; }
    const docData = snap.data();
    const meta = cloudGetMeta(); const lastPull = meta.lastPull||0;
    const cloudMs = docData.updatedAt?.toMillis ? docData.updatedAt.toMillis() : 0;
    if(cloudMs && cloudMs > lastPull && Array.isArray(docData.data)){
      const shouldPull = confirm('× ××¦× ×’×™×‘×•×™ ×—×“×© ×‘×¢× ×Ÿ. ×œ×˜×¢×•×Ÿ ××”×¢× ×Ÿ?\n(××™×©×•×¨ ×™×—×œ×™×£ ××ª ×”× ×ª×•× ×™× ×”××§×•××™×™×.)');
      if(shouldPull){
        DB = docData.data; normalizeDB(); await saveDB(); renderAll(); cloudToast('âœ… × ×˜×¢×Ÿ ××”×¢× ×Ÿ');
      }
      meta.lastPull = Date.now(); cloudSetMeta(meta);
    }
    cloudUI('ok','×¢× ×Ÿ: ××—×•×‘×¨');
  }catch(e){ console.warn(e); cloudUI('err','×¢× ×Ÿ: ×©×’×™××ª ×˜×¢×™× ×”'); }
  finally{ CLOUD.pulling=false; }
}

const __origSaveDB = saveDB;
saveDB = async function(){ await __origSaveDB(); cloudSchedulePush(); };

window.addEventListener('load', ()=>{
  const btn=document.getElementById('cloudSyncBtn');
  if(btn){ btn.addEventListener('click', ()=>{ if(!CLOUD.ready) return cloudInit(); cloudPush(); }); }
  cloudInit();
});
/* ---------- /Cloud Backup (Firebase) ---------- */

</script>
</body>
</html>
